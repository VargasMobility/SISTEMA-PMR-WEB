<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cargo Mobility PMR ‚Äì Panel Supervisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Librer√≠a para leer Excel (.xlsx / .xls) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      font-family:Arial, sans-serif;
      background:#111827;
      color:#0b1020;
    }

    /* HEADER ‚Äì azul institucional */
    header{
      background:linear-gradient(90deg,#1e3a8a,#1d4ed8,#3b82f6);
      color:#fff;
      padding:10px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 4px 14px rgba(0,0,0,.6);
      border-bottom:2px solid rgba(59,130,246,.7);
    }
    header .brand{display:flex;flex-direction:column;}
    header .brand-name{font-size:18px;font-weight:bold;letter-spacing:.03em;}
    header .brand-sub{font-size:11px;opacity:.9;}
    header .status{font-size:11px;text-align:right;opacity:.95;}

    .app{
      display:flex;
      height:calc(100vh - 52px);
      background:
        radial-gradient(circle at top left, rgba(59,130,246,.14), transparent 60%),
        radial-gradient(circle at bottom right, rgba(248,113,113,.15), transparent 55%),
        linear-gradient(135deg,#111827,#020617 55%,#1f2937);
    }

    /* SIDEBAR ‚Äì fondo azul, acentos rojos */
    .sidebar{
      width:320px;
      background:radial-gradient(circle at top,#1e3a8a,#1d4ed8 60%,#111827 100%);
      color:#e5e7eb;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      border-right:1px solid rgba(59,130,246,.7);
      box-shadow:4px 0 20px rgba(0,0,0,.6);
    }

    .sidebar-section-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:#bfdbfe;
      margin-bottom:4px;
    }

    .nav{display:flex;flex-direction:column;gap:4px;}
    .nav-btn{
      border:none;
      border-radius:8px;
      background:linear-gradient(120deg,#7f1d1d,#b91c1c);
      color:#e5e7eb;
      padding:7px 10px;
      font-size:12px;
      text-align:left;
      cursor:pointer;
      transition:background .15s,transform .05s, box-shadow .15s, border .15s;
      box-shadow:0 2px 6px rgba(15,23,42,.7);
      border:1px solid rgba(254,226,226,.9);
    }
    .nav-btn:hover{
      background:linear-gradient(120deg,#b91c1c,#ef4444);
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(15,23,42,.8);
    }
    .nav-btn.active{
      background:linear-gradient(120deg,#1d4ed8,#3b82f6);
      color:#fef2f2;
      font-weight:600;
      border:1px solid rgba(191,219,254,.9);
      box-shadow:0 4px 10px rgba(30,64,175,.8);
    }

    .actions-box{
      background:#0b1020;
      border-radius:14px;
      padding:10px;
      font-size:12px;
      border:1px solid rgba(248,113,113,.7);
      box-shadow:0 8px 22px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .actions-box::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(90deg, rgba(248,113,113,.18) 1px, transparent 1px),
        linear-gradient(180deg, rgba(248,113,113,.18) 1px, transparent 1px);
      background-size:20px 20px;
      opacity:.25;
      pointer-events:none;
    }
    .actions-box > *{position:relative;z-index:1;}

    /* ‚úÖ 4 ACCIONES PRINCIPALES */
    .main-action-tabs{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:4px;
      margin-bottom:8px;
    }
    .main-action-btn{
      border:none;
      border-radius:8px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      padding:6px 6px;
      font-size:11px;
      cursor:pointer;
      text-align:center;
      transition:background .15s, box-shadow .15s, transform .05s, border .15s;
      border:1px solid rgba(248,113,113,.7);
      user-select:none;
    }
    .main-action-btn:hover{
      background:linear-gradient(135deg,#b91c1c,#ef4444);
      box-shadow:0 3px 8px rgba(15,23,42,.9);
      transform:translateY(-1px);
    }
    .main-action-btn.active{
      background:linear-gradient(135deg,#1d4ed8,#3b82f6);
      color:#fef2f2;
      font-weight:700;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
      border:1px solid rgba(191,219,254,.95);
    }

    /* Sub-men√∫s por acci√≥n principal */
    .action-menu{
      border-radius:12px;
      background:radial-gradient(circle at top left,#0f172a,#020617 60%,#020617 100%);
      padding:8px;
      box-shadow:inset 0 0 0 1px rgba(248,113,113,.7);
      display:none;
    }
    .action-menu.active{display:block;}

    .sub-action-tabs{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:4px;
      margin-bottom:8px;
    }
    .sub-action-btn{
      border:none;
      border-radius:8px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      padding:5px 6px;
      font-size:11px;
      cursor:pointer;
      text-align:center;
      transition:background .15s, box-shadow .15s, transform .05s, border .15s;
      border:1px solid rgba(248,113,113,.7);
      user-select:none;
    }
    .sub-action-btn:hover{
      background:linear-gradient(135deg,#b91c1c,#ef4444);
      box-shadow:0 3px 8px rgba(15,23,42,.9);
      transform:translateY(-1px);
    }
    .sub-action-btn.active{
      background:linear-gradient(135deg,#1d4ed8,#3b82f6);
      color:#fef2f2;
      font-weight:700;
      box-shadow:0 4px 10px rgba(0,0,0,.8);
      border:1px solid rgba(191,219,254,.95);
    }

    /* Formularios */
    .action-form{
      margin-top:6px;
      border-radius:10px;
      background:rgba(2,6,23,.5);
      padding:8px;
      box-shadow:inset 0 0 0 1px rgba(30,64,175,.45);
    }
    .action-form.hidden{display:none;}

    label{
      display:block;
      margin-top:6px;
      font-size:11px;
      color:#e5e7eb;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    select,
    textarea{
      width:100%;
      margin-top:2px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:12px;
      outline:none;
      transition:border .12s, box-shadow .12s, background .12s;
    }
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    select:focus,
    textarea:focus{
      border-color:#ef4444;
      box-shadow:0 0 0 1px rgba(248,113,113,.85);
      background:#020617;
    }
    textarea{resize:vertical;min-height:52px;}
    input[type="file"]{
      width:100%;
      margin-top:4px;
      padding:4px;
      border-radius:6px;
      border:1px solid #374151;
      background:#020617;
      color:#e5e7eb;
      font-size:12px;
    }

    .btn-submit{
      margin-top:8px;
      padding:7px 10px;
      border:none;
      border-radius:999px;
      background:linear-gradient(120deg,#b91c1c,#ef4444);
      color:#fef2f2;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 3px 8px rgba(15,23,42,.9);
      transition:background .15s, box-shadow .15s, transform .05s;
      width:100%;
      text-transform:uppercase;
      letter-spacing:.08em;
      font-weight:600;
    }
    .btn-submit:hover{
      background:linear-gradient(120deg,#ef4444,#f97373);
      box-shadow:0 5px 12px rgba(15,23,42,1);
      transform:translateY(-1px);
    }
    .btn-submit:disabled{
      opacity:.6;
      cursor:default;
      box-shadow:none;
    }

    .helper-text{
      font-size:10px;
      color:#9ca3af;
      margin-top:4px;
    }
    .msg{font-size:11px;margin-top:4px;color:#e5e7eb;}
    .msg.ok{color:#4ade80;}
    .msg.err{color:#fb923c;}

    /* MAIN */
    .main{
      flex:1;
      padding:10px 14px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:
        radial-gradient(circle at top,#1d4ed8 0,#111827 45%),
        radial-gradient(circle at bottom,#7f1d1d 0,#020617 55%);
    }

    .view-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      color:#e5e7eb;
    }
    .view-title{
      font-size:17px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .view-filters{display:flex;gap:6px;flex-wrap:wrap;font-size:11px;align-items:center;}

    .chip{
      border-radius:999px;
      border:1px solid rgba(59,130,246,.9);
      background:linear-gradient(120deg,rgba(37,99,235,.25),rgba(248,113,113,.15));
      padding:2px 10px;
      color:#fef2f2;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 6px rgba(15,23,42,.8);
    }
    .chip-label{font-weight:700;text-transform:uppercase;font-size:10px;}

    .view-container{
      background:radial-gradient(circle at top left,#020617,#020617 35%,#0b1120 100%);
      border-radius:14px;
      padding:10px;
      box-shadow:0 14px 40px rgba(0,0,0,.85);
      border-top:2px solid rgba(59,130,246,.9);
      border-left:1px solid rgba(248,113,113,.7);
    }

    .empty-state{
      padding:16px;
      font-size:12px;
      color:#9ca3af;
      text-align:center;
      border-radius:10px;
      border:1px dashed rgba(248,113,113,.7);
      background:rgba(15,23,42,.9);
      margin-top:6px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:6px;
      color:#e5e7eb;
      border-radius:10px;
      overflow:hidden;
    }
    th,td{
      border:1px solid rgba(30,64,175,.7);
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:linear-gradient(90deg,#b91c1c,#dc2626,#f97373);
      color:#fefce8;
      position:sticky;
      top:0;
      z-index:1;
      border-bottom:2px solid rgba(59,130,246,.85);
      text-transform:uppercase;
      letter-spacing:.06em;
      font-size:10px;
    }
    tr:nth-child(even){
      background:rgba(15,23,42,.9);
    }
    tr:nth-child(odd){
      background:rgba(17,24,39,.95);
    }
    tr:hover{
      background:radial-gradient(circle at left,#2563eb 0,transparent 55%);
    }

    .view-section{display:none;}
    .view-section.active{display:block;}

    @media(max-width:900px){
      .app{flex-direction:column;height:auto;}
      .sidebar{width:100%;}
      .main-action-tabs{grid-template-columns:repeat(2,1fr);}
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <span class="brand-name">Cargo Mobility ‚Äì PMR</span>
    <span class="brand-sub">Panel Supervisor / CDO</span>
  </div>
  <div class="status">
    <div id="api-status">Conectando con API...</div>
    <div id="last-update">√öltima actualizaci√≥n: --</div>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <!-- VISTAS -->
    <div>
      <div class="sidebar-section-title">Vistas</div>
      <div class="nav">
        <button class="nav-btn active" data-view="vuelos">Vuelos</button>
        <button class="nav-btn" data-view="pmr">Pasajeros PMR</button>
        <button class="nav-btn" data-view="asignaciones">Asignaciones</button>
        <button class="nav-btn" data-view="agentes">Agentes</button>
      </div>
    </div>

    <!-- ACCIONES -->
    <div>
      <div class="sidebar-section-title">Acciones</div>
      <div class="actions-box">

        <!-- ‚úÖ 4 acciones principales -->
        <div class="main-action-tabs">
          <button class="main-action-btn active" data-menu="menu-vuelos">Vuelos</button>
          <button class="main-action-btn" data-menu="menu-pmr">PMR</button>
          <button class="main-action-btn" data-menu="menu-asignaciones">Asignaci√≥n</button>
          <button class="main-action-btn" data-menu="menu-carga">Carga</button>
        </div>

        <!-- MENU: VUELOS (sub-men√∫: Crear/Modificar) -->
        <div id="menu-vuelos" class="action-menu active">
          <div class="sub-action-tabs">
            <button class="sub-action-btn active" data-form="form-crear-vuelo">Crear vuelo</button>
            <button class="sub-action-btn" data-form="form-modificar-vuelo">Modificar vuelo</button>
          </div>

          <!-- FORM CREAR VUELO -->
          <div id="form-crear-vuelo" class="action-form">
            <label>Fecha vuelo
              <input type="date" id="crear-fecha" />
            </label>
            <label>Hora programada
              <input type="time" id="crear-hora" />
            </label>
            <label>Aerol√≠nea
              <input type="text" id="crear-aerolinea" placeholder="Sky, LATAM, etc." />
            </label>
            <label>N√∫mero de vuelo
              <input type="text" id="crear-numero" placeholder="LA345" />
            </label>
            <label>Terminal
              <select id="crear-terminal">
                <option value="">‚Äî Seleccionar ‚Äî</option>
                <option value="Nacional">Nacional</option>
                <option value="Internacional">Internacional</option>
              </select>
            </label>
            <label>Puerta
              <input type="text" id="crear-puerta" placeholder="1‚Äì13" />
            </label>
            <label>Espig√≥n
              <input type="text" id="crear-espigon" placeholder="A‚ÄìF" />
            </label>
            <label>Tipo de avi√≥n
              <select id="crear-tipo-avion">
                <option value="">‚Äî Seleccionar ‚Äî</option>
                <option value="NB">NB</option>
                <option value="WB">WB</option>
              </select>
            </label>
            <label>Origen (c√≥digo)
              <input type="text" id="crear-origen-vuelo" placeholder="SCL, LIM, etc." />
            </label>
            <label>Destino (c√≥digo)
              <input type="text" id="crear-destino-vuelo" placeholder="SCL, LIM, etc." />
            </label>
            <label>Cant. pasajeros PMR
              <input type="number" id="crear-cant-pmr" min="0" value="0" />
            </label>
            <label>Tipo de servicio
              <select id="crear-tipo-servicio">
                <option value="">‚Äî Seleccionar ‚Äî</option>
                <option value="Embarque">Embarque</option>
                <option value="Desembarque">Desembarque</option>
              </select>
            </label>
            <label>Estado de vuelo
              <select id="crear-estado-vuelo">
                <option value="Programado">Programado</option>
                <option value="Modificado">Modificado</option>
                <option value="Retrasado">Retrasado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </label>
            <label>Observaciones
              <textarea id="crear-obs"></textarea>
            </label>

            <button class="btn-submit" id="btn-crear-vuelo">Guardar vuelo</button>
            <div class="helper-text">Al crear, se generar√° un ID_Vuelo √∫nico.</div>
            <div class="msg" id="msg-crear-vuelo"></div>
          </div>

          <!-- FORM MODIFICAR VUELO -->
          <div id="form-modificar-vuelo" class="action-form hidden">
            <label>Seleccionar vuelo (s√≥lo hoy)
              <select id="modificar-id-vuelo">
                <option value="">‚Äî Seleccionar ‚Äî</option>
              </select>
            </label>
            <label>Nueva fecha
              <input type="date" id="modificar-fecha" />
            </label>
            <label>Nueva hora
              <input type="time" id="modificar-hora" />
            </label>
            <label>Nueva puerta
              <input type="text" id="modificar-puerta" />
            </label>
            <label>Nuevo espig√≥n
              <input type="text" id="modificar-espigon" />
            </label>

            <button class="btn-submit" id="btn-modificar-vuelo">Modificar vuelo</button>
            <div class="helper-text">S√≥lo se permiten modificaciones en vuelos del d√≠a actual.</div>
            <div class="msg" id="msg-modificar-vuelo"></div>
          </div>
        </div>

        <!-- MENU: PMR (sub-men√∫ opcional, por ahora 1 acci√≥n) -->
        <div id="menu-pmr" class="action-menu">
          <div class="sub-action-tabs" style="grid-template-columns:1fr;">
            <button class="sub-action-btn active" data-form="form-crear-pmr">Crear pasajero</button>
          </div>

          <!-- FORM CREAR PASAJERO PMR -->
          <div id="form-crear-pmr" class="action-form">
            <label>Vuelo (n√∫mero + fecha)
              <select id="crear-pmr-vuelo">
                <option value="">‚Äî Seleccionar vuelo ‚Äî</option>
              </select>
            </label>
            <label>Nombre pasajero PMR
              <input type="text" id="crear-pmr-nombre" placeholder="Nombre completo" />
            </label>
            <label>Tipo de asistencia
              <input type="text" id="crear-pmr-tipo" placeholder="WHL_SLC, etc." />
            </label>
            <label>Edad
              <input type="number" id="crear-pmr-edad" min="0" />
            </label>
            <label>Origen (c√≥digo)
              <input type="text" id="crear-pmr-origen" placeholder="SCL, LIM, etc." />
            </label>
            <label>Destino (c√≥digo)
              <input type="text" id="crear-pmr-destino" placeholder="SCL, LIM, etc." />
            </label>
            <label>Observaciones
              <textarea id="crear-pmr-obs"></textarea>
            </label>

            <button class="btn-submit" id="btn-crear-pmr">Crear pasajero PMR</button>
            <div class="helper-text">
              El pasajero se crear√° en estado <b>En espera</b> y se actualizar√° la cantidad de PMR del vuelo.
            </div>
            <div class="msg" id="msg-crear-pmr"></div>
          </div>
        </div>

        <!-- MENU: ASIGNACI√ìN (‚úÖ acci√≥n principal con su propio men√∫) -->
        <div id="menu-asignaciones" class="action-menu">
          <div class="sub-action-tabs" style="grid-template-columns:1fr;">
            <button class="sub-action-btn active" data-form="form-asignar-pmr">Asignar PMR</button>
          </div>

          <!-- FORM ASIGNAR PMR -->
          <div id="form-asignar-pmr" class="action-form">
            <label>Pasajero PMR (s√≥lo <b>En espera</b>)
              <select id="asig-select-pmr">
                <option value="">‚Äî Seleccionar PMR ‚Äî</option>
              </select>
            </label>

            <label>Agente (s√≥lo <b>Disponible</b> en misma terminal)
              <select id="asig-select-agente">
                <option value="">‚Äî Selecciona primero un PMR ‚Äî</option>
              </select>
            </label>

            <label>Tipo de traslado
              <select id="asig-tipo-traslado">
                <option value="">‚Äî Seleccionar ‚Äî</option>
                <option value="Ultima Milla">√öltima Milla</option>
                <option value="Tramo Completo">Tramo Completo</option>
              </select>
            </label>

            <!-- Campos solo lectura ORIGEN/DESTINO -->
            <label>Origen (auto)
              <input type="text" id="asig-origen" readonly />
            </label>

            <label>Destino (auto)
              <input type="text" id="asig-destino" readonly />
            </label>
            <div class="helper-text">
              Origen y destino se calculan autom√°ticamente seg√∫n el tipo de servicio del vuelo,
              el tipo de asistencia del PMR y el tipo de traslado.
            </div>

            <label>Observaciones
              <textarea id="asig-obs"></textarea>
            </label>

            <button class="btn-submit" id="btn-asignar-pmr">Asignar</button>
            <div class="helper-text">
              Al asignar, el PMR pasa a <b>En asignaci√≥n</b> y el agente queda <b>En asignaci√≥n</b> (espera de aceptaci√≥n con l√≠mite de 7 min).
            </div>
            <div class="msg" id="msg-asignar-pmr"></div>
          </div>
        </div>

        <!-- MENU: CARGA (sub-men√∫ opcional, por ahora 1 acci√≥n) -->
        <div id="menu-carga" class="action-menu">
          <div class="sub-action-tabs" style="grid-template-columns:1fr;">
            <button class="sub-action-btn active" data-form="form-carga-masiva">Carga masiva</button>
          </div>

          <!-- FORM CARGA MASIVA -->
          <div id="form-carga-masiva" class="action-form">
            <label>Archivo Excel (.xlsx / .xls)
              <input type="file" id="input-carga-masiva" accept=".xlsx,.xls" />
            </label>
            <div class="helper-text">
              Columnas A‚ÄìO: Nombre, RUT, Edad, Fecha_Vuelo, Hora, Tipo_Vuelo, Vuelo, Tipo_Avion, Aerol√≠nea,
              Terminal, Origen, Destino, Puerta, Espig√≥n, Tipo_PMR.
            </div>
            <button class="btn-submit" id="btn-carga-masiva">Procesar archivo</button>
            <div class="msg" id="msg-carga-masiva"></div>
          </div>
        </div>

      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="view-header">
      <div class="view-title" id="view-title">Vuelos</div>
      <div class="view-filters">
        <button class="btn-submit" id="btn-actualizar" style="width:auto;padding:4px 10px;font-size:11px;">
          Actualizar datos
        </button>
        <!-- Conteo regresivo de autorefresco -->
        <div class="chip" id="auto-refresh-box" style="display:none;">
          <span class="chip-label">Auto-refresco</span>
          <span>en <span id="auto-refresh-label">45</span> s</span>
        </div>
        <div class="chip" id="chip-info-vista">
          <span class="chip-label">Vuelos:</span>
          <span>Mostrando hoy y ma√±ana</span>
        </div>
      </div>
    </div>

    <div class="view-container">
      <!-- VISTA VUELOS -->
      <section id="view-vuelos" class="view-section active">
        <!-- Filtros de Vuelos -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:150px;">
            <label>Filtro N¬∞ vuelo
              <input type="text" id="filtro-vuelo-num" placeholder="Ej: LA345" />
            </label>
          </div>
          <div style="min-width:150px;">
            <label>Aerol√≠nea (autocompletar)
              <input type="text" id="filtro-aerolinea" list="lista-aerolineas" placeholder="Todas" />
              <datalist id="lista-aerolineas"></datalist>
            </label>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID Vuelo</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Aerol√≠nea</th>
              <th>N¬∞ Vuelo</th>
              <th>Terminal</th>
              <th>Puerta</th>
              <th>Espig√≥n</th>
              <th>Cant PMR</th>
              <th>Tipo servicio</th>
              <th>Estado</th>
              <th>Tipo</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Obs</th>
            </tr>
          </thead>
          <tbody id="tbody-vuelos"></tbody>
        </table>
        <div class="empty-state" id="empty-vuelos" style="display:none;">
          No hay vuelos para hoy o ma√±ana (con PMR En espera / En asignaci√≥n).
        </div>
      </section>

      <!-- VISTA PASAJEROS PMR -->
      <section id="view-pmr" class="view-section">
        <!-- Filtros PMR -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:180px;">
            <label>Filtrar por N¬∞ de vuelo
              <select id="filtro-pmr-vuelo">
                <option value="">Todos</option>
              </select>
            </label>
          </div>
          <div style="min-width:180px;">
            <label>Filtrar por Estado
              <select id="filtro-pmr-estado">
                <option value="">Todos</option>
              </select>
            </label>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID PMR</th>
              <th>Vuelo</th>
              <th>Nombre</th>
              <th>Tipo asistencia</th>
              <th>Edad</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Estado</th>
              <th>ID Agente</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Obs</th>
            </tr>
          </thead>
          <tbody id="tbody-pmr"></tbody>
        </table>
        <div class="empty-state" id="empty-pmr" style="display:none;">
          No hay pasajeros PMR para los filtros seleccionados.
        </div>
      </section>

      <!-- VISTA ASIGNACIONES -->
      <section id="view-asignaciones" class="view-section">
        <!-- Filtros Asignaciones -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:150px;">
            <label>Filtro N¬∞ vuelo
              <input type="text" id="filtro-asig-vuelo-num" placeholder="Ej: LA345" />
            </label>
          </div>
          <div style="min-width:150px;">
            <label>Fecha asignaci√≥n
              <input type="date" id="filtro-asig-fecha" />
            </label>
          </div>
          <div style="min-width:150px;">
            <label>Tipo traslado
              <select id="filtro-asig-tipo">
                <option value="">Todos</option>
              </select>
            </label>
          </div>
          <div style="min-width:150px;">
            <label>Estado
              <select id="filtro-asig-estado">
                <option value="">Todos</option>
              </select>
            </label>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID Asignaci√≥n</th>
              <th>ID Vuelo</th>
              <th>ID PMR</th>
              <th>ID Agente</th>
              <th>Fecha</th>
              <th>Hora Asig.</th>
              <th>Hora Aceptaci√≥n</th>
              <th>Vence (7 min)</th>
              <th>Hora inicio</th>
              <th>Hora fin</th>
              <th>Estado</th>
              <th>Obs</th>
              <th>Tipo traslado</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Justificaci√≥n cancelaci√≥n</th>
              <th>Hora l√≠mite vuelo</th>
            </tr>
          </thead>
          <tbody id="tbody-asignaciones"></tbody>
        </table>
        <div class="empty-state" id="empty-asignaciones" style="display:none;">
          No hay asignaciones registradas para los filtros seleccionados.
        </div>
      </section>

      <!-- VISTA AGENTES -->
      <section id="view-agentes" class="view-section">
        <table>
          <thead>
            <tr>
              <th>ID Agente</th>
              <th>Nombre</th>
              <th>RUT</th>
              <th>Tel√©fono</th>
              <th>Estado</th>
              <th>Estado Servicio</th>
              <th>√öltimo Servicio</th>
              <th>Observaciones</th>
              <th>Ubicaci√≥n</th>
            </tr>
          </thead>
          <tbody id="tbody-agentes"></tbody>
        </table>
        <div class="empty-state" id="empty-agentes" style="display:none;">
          No hay agentes configurados.
        </div>
      </section>
    </div>
  </main>
</div>

<script>
  // üëâ URL del Web App
  const API_URL = "https://script.google.com/macros/s/AKfycbwFBHpIx-gQrVAvj5Vv-I-l1X3NR9MYbyTV9CtxgKCw7oPeuxIE5qrYx3eZdDoIroTE/exec";

  let cacheVuelos = [];
  let cachePasajeros = [];
  let cacheAsignaciones = [];
  let cacheAgentes = [];

  // Autorefresco (3 minutos, aviso √∫ltimos 45 s)
  let autoRefreshInterval = null;
  let autoRefreshSeconds = 180;

  function iniciarAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshSeconds = 180;

    const box = document.getElementById("auto-refresh-box");
    const label = document.getElementById("auto-refresh-label");
    if (box) box.style.display = "none";

    autoRefreshInterval = setInterval(async () => {
      autoRefreshSeconds--;

      if (autoRefreshSeconds <= 0) {
        autoRefreshSeconds = 180;
        await cargarDatos(true);
      }

      if (!box || !label) return;

      if (autoRefreshSeconds <= 45) {
        box.style.display = "inline-flex";
        label.textContent = autoRefreshSeconds;
      } else {
        box.style.display = "none";
      }
    }, 1000);
  }

  function detenerAutoRefresh() {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
    const box = document.getElementById("auto-refresh-box");
    if (box) box.style.display = "none";
  }

  /* --------- UTILIDADES FECHA / HORA --------- */
  function parseFechaSolo(fecha) {
    if (!fecha) return null;
    if (fecha instanceof Date) return new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());

    const s = String(fecha).trim();
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) {
      return new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));
    }
    // tambi√©n podr√≠a venir como yyyy-mm-dd
    m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) {
      return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
    }
    const d = new Date(s);
    if (!isNaN(d)) {
      return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    return null;
  }

  function hoyTrunc() {
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function addDias(date, dias) {
    const d = new Date(date);
    d.setDate(d.getDate() + dias);
    return d;
  }

  function formatearHora(horaRaw) {
    if (!horaRaw) return "";
    if (horaRaw instanceof Date) {
      const hh = String(horaRaw.getHours()).padStart(2,"0");
      const mm = String(horaRaw.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    const s = String(horaRaw);
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,"0")}:${m[2]}`;
    return s;
  }

  // Normalizar fecha proveniente de Excel a yyyy-mm-dd
  function normalizarFechaExcel(valor) {
    if (valor === null || valor === undefined || valor === "") return "";

    if (typeof valor === "number") {
      const date = new Date(Math.round((valor - 25569) * 86400 * 1000));
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2,"0");
      const dd = String(date.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    const s = String(valor).trim();
    let m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) {
      const yyyy = m[1];
      const mm = m[2].padStart(2,"0");
      const dd = m[3].padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) {
      const dd = m[1].padStart(2,"0");
      const mm = m[2].padStart(2,"0");
      const yyyy = m[3];
      return `${yyyy}-${mm}-${dd}`;
    }
    const d = new Date(s);
    if (!isNaN(d)) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    return s;
  }

  // Normalizar hora Excel a HH:mm
  function normalizarHoraExcel(valor) {
    if (valor === null || valor === undefined || valor === "") return "";

    if (typeof valor === "number") {
      const totalSeconds = Math.round(valor * 86400);
      const hh = String(Math.floor(totalSeconds / 3600) % 24).padStart(2,"0");
      const mm = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    const s = String(valor).trim();
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,"0")}:${m[2]}`;
    return s;
  }

  /* --------- C√ÅLCULO ORIGEN/DESTINO (MISMA L√ìGICA QUE BACKEND) --------- */
  function calcularOrigenDestinoFront(tipoServicioVuelo, tipoAsistencia, tipoTraslado, puerta, espigon) {
    const ts = (tipoServicioVuelo || "").toString().toLowerCase().trim();   // embarque / desembarque
    const ta = (tipoAsistencia || "").toString().toUpperCase().trim();      // WHC / WHR / WHS / otros
    const tt = (tipoTraslado || "").toString().toLowerCase().trim();        // √∫ltima milla / tramo completo

    const puertaEspigon   = ((puerta || "") + (espigon || "")).trim();
    const puertaEmbarque  = puertaEspigon ? `Puerta Embarque ${puertaEspigon}` : "Puerta Embarque";

    const esUltimaMilla   = tt.indexOf("ultima") !== -1 || tt.indexOf("√∫ltima") !== -1;
    const esTramoCompleto = tt.indexOf("tramo") !== -1;

    const esWHC          = (ta === "WHC");
    const etiquetaAvion  = esWHC ? "Asiento Avi√≥n" : "Puerta Avi√≥n";

    let origen  = "";
    let destino = "";

    if (esUltimaMilla) {
      if (ts === "embarque") { origen = puertaEmbarque; destino = etiquetaAvion; }
      else if (ts === "desembarque") { origen = etiquetaAvion; destino = puertaEmbarque; }
    } else if (esTramoCompleto) {
      if (ts === "embarque") { origen = "Elecci√≥n del Pasajero"; destino = etiquetaAvion; }
      else if (ts === "desembarque") { origen = etiquetaAvion; destino = "Elecci√≥n del Pasajero"; }
    }

    return { origen, destino };
  }

  function normalizarEstado(s) {
    return (s || "").toString().trim().toLowerCase();
  }

  function estadoPmrCuentaParaVuelos(estado) {
    const e = normalizarEstado(estado);
    return e === "en espera" || e === "en asignacion" || e === "en asignaci√≥n";
  }

  function construirVence7Min(fechaAsignacion, horaAsignacion) {
    if (!fechaAsignacion || !horaAsignacion) return "";
    const fa = parseFechaSolo(fechaAsignacion);
    if (!fa) return "";
    const hs = formatearHora(horaAsignacion);
    const m = String(hs).match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return "";
    const h = parseInt(m[1], 10);
    const mi = parseInt(m[2], 10);
    const dt = new Date(fa.getFullYear(), fa.getMonth(), fa.getDate(), h, mi, 0, 0);
    if (isNaN(dt.getTime())) return "";
    dt.setMinutes(dt.getMinutes() + 7);
    const hh = String(dt.getHours()).padStart(2,"0");
    const mm = String(dt.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
  }

  /* --------- CARGA DE DATOS --------- */
  async function cargarDatos(silencioso = false) {
    const apiStatus = document.getElementById("api-status");
    const lastUpdate = document.getElementById("last-update");
    apiStatus.textContent = "Conectando con API...";

    try {
      const res = await fetch(API_URL + "?action=listAll");
      const json = await res.json();

      if (!json.ok) throw new Error(json.error || "Error en listAll");

      cacheVuelos        = json.vuelos || [];
      cachePasajeros     = json.pasajeros || [];
      cacheAsignaciones  = json.asignaciones || [];
      cacheAgentes       = json.agentes || [];

      apiStatus.textContent = "Conectado a la API";
      const ahora = new Date();
      lastUpdate.textContent = "√öltima actualizaci√≥n: " +
        ahora.toLocaleTimeString("es-CL", {hour:"2-digit", minute:"2-digit"});

      renderVistaActual();
      llenarCombosAcciones();
      iniciarAutoRefresh();
    } catch (err) {
      console.error(err);
      apiStatus.textContent = "Error al conectar con la API";
      if (!silencioso) alert("Error al cargar datos: " + (err.message || err));
    }
  }

  /* --------- RENDERIZADO DE VISTAS --------- */
  function renderVistaActual() {
    const btnActivo = document.querySelector(".nav-btn.active");
    const vista = btnActivo ? btnActivo.dataset.view : "vuelos";

    if (vista === "vuelos") renderVistaVuelos();
    else if (vista === "pmr") renderVistaPmr();
    else if (vista === "asignaciones") renderVistaAsignaciones();
    else if (vista === "agentes") renderVistaAgentes();
  }

  function renderVistaVuelos() {
    const tbody = document.getElementById("tbody-vuelos");
    const empty = document.getElementById("empty-vuelos");
    const filtroNumInput = document.getElementById("filtro-vuelo-num");
    const filtroAeroInput = document.getElementById("filtro-aerolinea");
    const datalistAero = document.getElementById("lista-aerolineas");
    tbody.innerHTML = "";

    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    const vuelosConPendiente = new Set();
    cachePasajeros
      .filter(p => estadoPmrCuentaParaVuelos(p.estadoPmr))
      .forEach(p => { if (p.vuelo) vuelosConPendiente.add(String(p.vuelo)); });

    const filtroNum = (filtroNumInput?.value || "").trim().toLowerCase();
    const filtroAero = (filtroAeroInput?.value || "").trim().toLowerCase();

    if (datalistAero) {
      const setAero = new Set();
      cacheVuelos.forEach(v => { if (v.aerolinea) setAero.add(String(v.aerolinea)); });
      datalistAero.innerHTML = "";
      Array.from(setAero).sort().forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        datalistAero.appendChild(opt);
      });
    }

    const filtrados = cacheVuelos.filter(v => {
      const f = parseFechaSolo(v.fecha);
      if (!f) return false;
      const esHoy = f.getTime() === hoy.getTime();
      const esManana = f.getTime() === manana.getTime();
      if (!esHoy && !esManana) return false;

      const numVuelo = (v.numeroVuelo || "").toString();
      const aerolinea = (v.aerolinea || "").toString();

      if (!vuelosConPendiente.has(numVuelo)) return false;
      if (filtroNum && !numVuelo.toLowerCase().includes(filtroNum)) return false;
      if (filtroAero && aerolinea.toLowerCase() !== filtroAero) return false;

      return true;
    });

    empty.style.display = filtrados.length ? "none" : "block";

    filtrados.forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.idVuelo || ""}</td>
        <td>${v.fecha || ""}</td>
        <td>${formatearHora(v.horaProgramada)}</td>
        <td>${v.aerolinea || ""}</td>
        <td>${v.numeroVuelo || ""}</td>
        <td>${v.terminal || ""}</td>
        <td>${v.puerta || ""}</td>
        <td>${v.espigon || ""}</td>
        <td>${v.cantPmr || 0}</td>
        <td>${v.tipoServicio || ""}</td>
        <td>${v.estadoVuelo || ""}</td>
        <td>${v.tipo || v.tipoAvion || ""}</td>
        <td>${v.origen || ""}</td>
        <td>${v.destino || ""}</td>
        <td>${v.observaciones || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Vuelos";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Vuelos:</span><span>Hoy y ma√±ana (PMR En espera / En asignaci√≥n)</span>`;
  }

  function renderVistaPmr() {
    const tbody = document.getElementById("tbody-pmr");
    const empty = document.getElementById("empty-pmr");
    const selFiltroVuelo = document.getElementById("filtro-pmr-vuelo");
    const selFiltroEstado = document.getElementById("filtro-pmr-estado");
    tbody.innerHTML = "";

    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    let pmrBase = cachePasajeros.filter(p => {
      const vuelo = cacheVuelos.find(v => String(v.numeroVuelo) === String(p.vuelo));
      if (!vuelo) return false;
      const f = parseFechaSolo(vuelo.fecha);
      if (!f) return false;
      const esHoy = f.getTime() === hoy.getTime();
      const esManana = f.getTime() === manana.getTime();
      return esHoy || esManana;
    });

    if (selFiltroVuelo) {
      const valorActual = selFiltroVuelo.value;
      selFiltroVuelo.innerHTML = '<option value="">Todos</option>';
      const setVuelos = new Set();
      pmrBase.forEach(p => { if (p.vuelo) setVuelos.add(String(p.vuelo)); });
      Array.from(setVuelos).sort().forEach(vu => {
        const opt = document.createElement("option");
        opt.value = vu;
        opt.textContent = vu;
        selFiltroVuelo.appendChild(opt);
      });
      if (valorActual) selFiltroVuelo.value = valorActual;
    }

    if (selFiltroEstado) {
      const valorActualEstado = selFiltroEstado.value;
      selFiltroEstado.innerHTML = '<option value="">Todos</option>';
      const setEstados = new Set();
      pmrBase.forEach(p => { if (p.estadoPmr) setEstados.add(String(p.estadoPmr)); });
      Array.from(setEstados).sort().forEach(est => {
        const opt = document.createElement("option");
        opt.value = est;
        opt.textContent = est;
        selFiltroEstado.appendChild(opt);
      });
      if (valorActualEstado) selFiltroEstado.value = valorActualEstado;
    }

    const vueloFiltro = (selFiltroVuelo?.value || "").trim();
    const estadoFiltro = (selFiltroEstado?.value || "").trim();

    if (vueloFiltro) pmrBase = pmrBase.filter(p => String(p.vuelo) === vueloFiltro);
    if (estadoFiltro) pmrBase = pmrBase.filter(p => String(p.estadoPmr || "").trim() === estadoFiltro);

    empty.style.display = pmrBase.length ? "none" : "block";

    pmrBase.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.idPmr || ""}</td>
        <td>${p.vuelo || ""}</td>
        <td>${p.nombre || ""}</td>
        <td>${p.tipoAsistencia || ""}</td>
        <td>${p.edad || ""}</td>
        <td>${p.origen || ""}</td>
        <td>${p.destino || ""}</td>
        <td>${p.estadoPmr || ""}</td>
        <td>${p.idAgente || ""}</td>
        <td>${formatearHora(p.horaInicio)}</td>
        <td>${formatearHora(p.horaFin)}</td>
        <td>${p.observaciones || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Pasajeros PMR";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">PMR:</span><span>Vuelos de hoy y ma√±ana (todos los estados)</span>`;
  }

  function renderVistaAsignaciones() {
    const tbody = document.getElementById("tbody-asignaciones");
    const empty = document.getElementById("empty-asignaciones");
    tbody.innerHTML = "";

    const filtroNumInput = document.getElementById("filtro-asig-vuelo-num");
    const filtroFechaInput = document.getElementById("filtro-asig-fecha");
    const selTipo = document.getElementById("filtro-asig-tipo");
    const selEstado = document.getElementById("filtro-asig-estado");

    if (selTipo) {
      const valActualTipo = selTipo.value;
      selTipo.innerHTML = '<option value="">Todos</option>';
      const setTipos = new Set();
      cacheAsignaciones.forEach(a => { if (a.tipoTraslado) setTipos.add(String(a.tipoTraslado)); });
      Array.from(setTipos).sort().forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        selTipo.appendChild(opt);
      });
      if (valActualTipo) selTipo.value = valActualTipo;
    }

    if (selEstado) {
      const valActualEstado = selEstado.value;
      selEstado.innerHTML = '<option value="">Todos</option>';
      const setEstados = new Set();
      cacheAsignaciones.forEach(a => { if (a.estadoAsignacion) setEstados.add(String(a.estadoAsignacion)); });
      Array.from(setEstados).sort().forEach(e => {
        const opt = document.createElement("option");
        opt.value = e;
        opt.textContent = e;
        selEstado.appendChild(opt);
      });
      if (valActualEstado) selEstado.value = valActualEstado;
    }

    const numFiltro = (filtroNumInput?.value || "").trim().toLowerCase();
    const fechaFiltro = (filtroFechaInput?.value || "").trim(); // yyyy-mm-dd
    const tipoFiltro = (selTipo?.value || "").trim().toLowerCase();
    const estadoFiltro = (selEstado?.value || "").trim().toLowerCase();

    const filtrados = cacheAsignaciones.filter(a => {
      if (numFiltro) {
        const vuelo = cacheVuelos.find(v => String(v.idVuelo) === String(a.idVuelo));
        const numVuelo = vuelo ? String(vuelo.numeroVuelo || "").toLowerCase() : "";
        if (!numVuelo.includes(numFiltro)) return false;
      }

      if (fechaFiltro) {
        const fa = parseFechaSolo(a.fechaAsignacion);
        const fFiltroDate = new Date(fechaFiltro);
        const fFiltro = new Date(fFiltroDate.getFullYear(), fFiltroDate.getMonth(), fFiltroDate.getDate());
        if (!fa || fa.getTime() !== fFiltro.getTime()) return false;
      }

      if (tipoFiltro) {
        const t = (a.tipoTraslado || "").toString().toLowerCase();
        if (t !== tipoFiltro) return false;
      }

      if (estadoFiltro) {
        const e = (a.estadoAsignacion || "").toString().toLowerCase();
        if (e !== estadoFiltro) return false;
      }

      return true;
    });

    empty.style.display = filtrados.length ? "none" : "block";

    filtrados.forEach(a => {
      const vence7 = (a.horaExpiracion ? formatearHora(a.horaExpiracion) : construirVence7Min(a.fechaAsignacion, a.horaAsignacion));
      const horaAcept = formatearHora(a.horaAceptacion || a.horaAceptada || a.horaAcept || "");
      const obs = a.observaciones || "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.idAsignacion || ""}</td>
        <td>${a.idVuelo || ""}</td>
        <td>${a.idPmr || ""}</td>
        <td>${a.idAgente || ""}</td>
        <td>${a.fechaAsignacion || ""}</td>
        <td>${formatearHora(a.horaAsignacion)}</td>
        <td>${horaAcept}</td>
        <td>${vence7}</td>
        <td>${formatearHora(a.horaInicio)}</td>
        <td>${formatearHora(a.horaFin)}</td>
        <td>${a.estadoAsignacion || ""}</td>
        <td>${obs}</td>
        <td>${a.tipoTraslado || ""}</td>
        <td>${a.origenAsignacion || ""}</td>
        <td>${a.destinoAsignacion || ""}</td>
        <td>${a.justificacionCancel || ""}</td>
        <td>${formatearHora(a.horaLimite)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Asignaciones";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Asignaciones:</span><span>Incluye control de aceptaci√≥n (7 min)</span>`;
  }

  function renderVistaAgentes() {
    const tbody = document.getElementById("tbody-agentes");
    const empty = document.getElementById("empty-agentes");
    tbody.innerHTML = "";

    if (!cacheAgentes.length) {
      empty.style.display = "block";
      return;
    }
    empty.style.display = "none";

    cacheAgentes.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.idAgente || ""}</td>
        <td>${a.nombre || ""}</td>
        <td>${a.rut || ""}</td>
        <td>${a.telefono || ""}</td>
        <td>${a.estado || ""}</td>
        <td>${a.estadoServicio || ""}</td>
        <td>${a.ultimoServicio || ""}</td>
        <td>${a.observaciones || ""}</td>
        <td>${a.ubicacion || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Agentes";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Agentes:</span><span>Lista completa de agentes</span>`;
  }

  /* --------- LLENAR COMBOS DE ACCIONES --------- */
  function llenarCombosAcciones() {
    const selMod = document.getElementById("modificar-id-vuelo");
    if (selMod) selMod.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';

    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    // MODIFICAR VUELO: solo vuelos de hoy
    if (selMod) {
      cacheVuelos.forEach(v => {
        const f = parseFechaSolo(v.fecha);
        if (!f || f.getTime() !== hoy.getTime()) return;

        const opt = document.createElement("option");
        opt.value = v.idVuelo;
        opt.textContent = `${v.numeroVuelo || v.idVuelo}`;
        selMod.appendChild(opt);
      });
    }

    // CREAR PASAJERO PMR: todos los vuelos
    const selCrearPmrVuelo = document.getElementById("crear-pmr-vuelo");
    if (selCrearPmrVuelo) {
      selCrearPmrVuelo.innerHTML = '<option value="">‚Äî Seleccionar vuelo ‚Äî</option>';
      cacheVuelos.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.numeroVuelo;
        opt.textContent = `${v.numeroVuelo} | ${v.fecha} | ${v.terminal || ""}`;
        selCrearPmrVuelo.appendChild(opt);
      });
    }

    // ASIGNAR PMR: solo "En espera" y vuelos HOY o MA√ëANA
    const selPmr = document.getElementById("asig-select-pmr");
    if (selPmr) {
      selPmr.innerHTML = '<option value="">‚Äî Seleccionar PMR ‚Äî</option>';

      cachePasajeros
        .filter(p => normalizarEstado(p.estadoPmr) === "en espera")
        .filter(p => {
          const vuelo = cacheVuelos.find(v => String(v.numeroVuelo) === String(p.vuelo));
          if (!vuelo) return false;
          const f = parseFechaSolo(vuelo.fecha);
          if (!f) return false;
          const esHoy = f.getTime() === hoy.getTime();
          const esManana = f.getTime() === manana.getTime();
          return esHoy || esManana;
        })
        .forEach(p => {
          const vuelo = cacheVuelos.find(v => String(v.numeroVuelo) === String(p.vuelo));
          const terminal = vuelo ? (vuelo.terminal || "") : "";
          const opt = document.createElement("option");
          opt.value = p.idPmr;
          opt.textContent = `[${p.idPmr}] ${p.vuelo} ¬∑ ${p.nombre} ¬∑ ${terminal || "Sin terminal"}`;
          selPmr.appendChild(opt);
        });
    }

    const selAg = document.getElementById("asig-select-agente");
    if (selAg) selAg.innerHTML = '<option value="">‚Äî Selecciona primero un PMR ‚Äî</option>';

    actualizarPreviewOrigenDestino();
  }

  function refrescarAgentesParaPmr() {
    const selPmr = document.getElementById("asig-select-pmr");
    const selAg = document.getElementById("asig-select-agente");
    if (!selPmr || !selAg) return;

    selAg.innerHTML = "";

    const idPmr = selPmr.value;
    if (!idPmr) {
      selAg.innerHTML = '<option value="">‚Äî Selecciona primero un PMR ‚Äî</option>';
      actualizarPreviewOrigenDestino();
      return;
    }

    const pmr = cachePasajeros.find(p => String(p.idPmr) === String(idPmr));
    if (!pmr) {
      selAg.innerHTML = '<option value="">No se encontr√≥ el PMR seleccionado</option>';
      actualizarPreviewOrigenDestino();
      return;
    }

    const vuelo = cacheVuelos.find(v => String(v.numeroVuelo) === String(pmr.vuelo));
    const terminal = vuelo ? (vuelo.terminal || "") : "";

    const disponibles = cacheAgentes.filter(a =>
      normalizarEstado(a.estadoServicio) === "disponible" &&
      (!terminal || String(a.ubicacion || "").toLowerCase() === String(terminal).toLowerCase())
    );

    if (!disponibles.length) {
      selAg.innerHTML = `<option value="">No hay agentes disponibles en ${terminal || "la terminal"}</option>`;
    } else {
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = `‚Äî Agentes disponibles en ${terminal || "terminal"} ‚Äî`;
      selAg.appendChild(placeholder);

      disponibles.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a.idAgente;
        opt.textContent = `${a.idAgente} ¬∑ ${a.nombre}`;
        selAg.appendChild(opt);
      });
    }

    actualizarPreviewOrigenDestino();
  }

  /* --------- PREVIEW ORIGEN/DESTINO EN ASIGNACI√ìN --------- */
  function actualizarPreviewOrigenDestino() {
    const inputOrigen  = document.getElementById("asig-origen");
    const inputDestino = document.getElementById("asig-destino");
    const selPmrEl = document.getElementById("asig-select-pmr");
    const selTipoEl = document.getElementById("asig-tipo-traslado");
    if (!inputOrigen || !inputDestino || !selPmrEl || !selTipoEl) return;

    const idPmr = selPmrEl.value;
    const tipoT = selTipoEl.value;

    if (!idPmr || !tipoT) {
      inputOrigen.value = "";
      inputDestino.value = "";
      return;
    }

    const pmr = cachePasajeros.find(p => String(p.idPmr) === String(idPmr));
    if (!pmr) { inputOrigen.value=""; inputDestino.value=""; return; }

    const vuelo = cacheVuelos.find(v => String(v.numeroVuelo) === String(pmr.vuelo));
    if (!vuelo) { inputOrigen.value=""; inputDestino.value=""; return; }

    const od = calcularOrigenDestinoFront(
      vuelo.tipoServicio,
      pmr.tipoAsistencia,
      tipoT,
      vuelo.puerta,
      vuelo.espigon
    );

    inputOrigen.value  = od.origen || "";
    inputDestino.value = od.destino || "";
  }

  /* --------- ACCIONES --------- */
  async function accionCrearVuelo() {
    const msg = document.getElementById("msg-crear-vuelo");
    msg.textContent = "";
    msg.className = "msg";

    const fecha    = document.getElementById("crear-fecha").value;
    const hora     = document.getElementById("crear-hora").value;
    const aerol    = document.getElementById("crear-aerolinea").value.trim();
    const num      = document.getElementById("crear-numero").value.trim();
    const term     = document.getElementById("crear-terminal").value;
    const puerta   = document.getElementById("crear-puerta").value.trim();
    const espigon  = document.getElementById("crear-espigon").value.trim();
    const tipoAvion= document.getElementById("crear-tipo-avion").value;
    const origenV  = document.getElementById("crear-origen-vuelo").value.trim();
    const destinoV = document.getElementById("crear-destino-vuelo").value.trim();
    const cantPmr  = document.getElementById("crear-cant-pmr").value;
    const tipo     = document.getElementById("crear-tipo-servicio").value;
    const estadoV  = document.getElementById("crear-estado-vuelo").value;
    const obs      = document.getElementById("crear-obs").value.trim();

    if (!fecha || !hora || !aerol || !num || !term || !tipo) {
      msg.textContent = "Completa al menos: fecha, hora, aerol√≠nea, n√∫mero, terminal y tipo servicio.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","createVuelo");
    params.append("fecha",fecha);
    params.append("horaProgramada",hora);
    params.append("aerolinea",aerol);
    params.append("numeroVuelo",num);
    params.append("terminal",term);
    params.append("puerta",puerta);
    params.append("espigon",espigon);
    params.append("cantPmr",cantPmr || "0");
    params.append("tipoServicio",tipo);
    if (estadoV)  params.append("estadoVuelo",estadoV);
    if (tipoAvion)params.append("tipoAvion",tipoAvion);
    if (origenV)  params.append("origen",origenV);
    if (destinoV) params.append("destino",destinoV);
    if (obs)      params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al crear vuelo");

      msg.textContent = "Vuelo creado correctamente. ID: " + json.idVuelo;
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al crear vuelo: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  async function accionModificarVuelo() {
    const msg = document.getElementById("msg-modificar-vuelo");
    msg.textContent = "";
    msg.className = "msg";

    const idVuelo = document.getElementById("modificar-id-vuelo").value;
    if (!idVuelo) {
      msg.textContent = "Selecciona un vuelo.";
      msg.className = "msg err";
      return;
    }

    const nuevaFecha   = document.getElementById("modificar-fecha").value;
    const nuevaHora    = document.getElementById("modificar-hora").value;
    const nuevaPuerta  = document.getElementById("modificar-puerta").value.trim();
    const nuevoEspigon = document.getElementById("modificar-espigon").value.trim();

    if (!nuevaFecha && !nuevaHora && !nuevaPuerta && !nuevoEspigon) {
      msg.textContent = "No hay cambios para aplicar.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","modificarVuelo");
    params.append("idVuelo",idVuelo);
    if (nuevaFecha)   params.append("nuevaFecha",nuevaFecha);
    if (nuevaHora)    params.append("nuevaHora",nuevaHora);
    if (nuevaPuerta)  params.append("nuevoPuerta",nuevaPuerta);
    if (nuevoEspigon) params.append("nuevoEspigon",nuevoEspigon);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al modificar vuelo");

      msg.textContent = "Vuelo modificado correctamente.";
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al modificar vuelo: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  // üëâ CARGA MASIVA: bloques de 2 registros + reintentos autom√°ticos (hasta 5) por bloque
  async function accionCargaMasiva() {
    const msg   = document.getElementById("msg-carga-masiva");
    const input = document.getElementById("input-carga-masiva");
    const btn   = document.getElementById("btn-carga-masiva");

    msg.textContent = "";
    msg.className = "msg";

    const file = input.files && input.files[0];
    if (!file) {
      msg.textContent = "Selecciona un archivo Excel (.xlsx / .xls).";
      msg.className = "msg err";
      return;
    }

    btn.disabled = true;
    msg.textContent = "Leyendo archivo...";

    const reader = new FileReader();

    reader.onerror = () => {
      msg.textContent = "No se pudo leer el archivo.";
      msg.className = "msg err";
      btn.disabled = false;
    };

    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const wsName = wb.SheetNames[0];
        const ws = wb.Sheets[wsName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        if (!rows || rows.length <= 1) {
          msg.textContent = "No se encontraron filas de datos en el archivo.";
          msg.className = "msg err";
          btn.disabled = false;
          return;
        }

        const registros = [];

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];

          const nombre      = (row[0]  || "").toString().trim();  // A
          const rut         = (row[1]  || "").toString().trim();  // B
          const edadRaw     = row[2];                             // C
          const fechaRaw    = row[3];                             // D
          const horaRaw     = row[4];                             // E
          const tipoVuelo   = (row[5]  || "").toString().trim();  // F
          const vueloNumRaw = row[6];                             // G
          const tipoAvion   = (row[7]  || "").toString().trim();  // H
          const aerolinea   = (row[8]  || "").toString().trim();  // I
          const terminal    = (row[9]  || "").toString().trim();  // J
          const origen      = (row[10] || "").toString().trim();  // K
          const destino     = (row[11] || "").toString().trim();  // L
          const puerta      = (row[12] || "").toString().trim();  // M
          const espigon     = (row[13] || "").toString().trim();  // N
          const tipoPmr     = (row[14] || "").toString().trim();  // O

          if (!nombre && !rut && !vueloNumRaw) continue;

          const numeroVuelo = vueloNumRaw ? String(vueloNumRaw).trim() : "";
          const fechaVuelo  = normalizarFechaExcel(fechaRaw);   // "yyyy-mm-dd"
          const hora        = normalizarHoraExcel(horaRaw);     // "HH:mm"
          const edad        = (edadRaw !== "" && edadRaw !== null && edadRaw !== undefined)
                                ? String(edadRaw).trim()
                                : "";

          if (!numeroVuelo || !fechaVuelo) continue;

          registros.push({
            nombre,
            rut,
            edad,
            fechaVuelo,
            hora,
            tipoVuelo,
            vuelo: numeroVuelo,
            tipoAvion,
            aerolinea,
            terminal,
            origen,
            destino,
            puerta,
            espigon,
            tipoPmr
          });
        }

        if (!registros.length) {
          msg.textContent = "No se generaron registros v√°lidos desde el archivo.";
          msg.className = "msg err";
          btn.disabled = false;
          return;
        }

        const chunkSize   = 2;
        const maxRetries  = 5;
        let totalPasajeros = 0;
        let totalVuelosNuevos = 0;
        let totalVuelosActualizados = 0;

        for (let i = 0; i < registros.length; i += chunkSize) {
          const chunk = registros.slice(i, i + chunkSize);
          const inicio = i + 1;
          const fin = Math.min(i + chunkSize, registros.length);

          let intentos = 0;
          let exito = false;

          while (!exito && intentos < maxRetries) {
            intentos++;
            try {
              msg.textContent =
                `Enviando registros ${inicio} a ${fin} de ${registros.length} ` +
                `(intento ${intentos}/${maxRetries})...`;

              const params = new URLSearchParams();
              params.append("action", "cargaMasivaPmr");
              params.append("payload", JSON.stringify(chunk));

              const res = await fetch(API_URL + "?" + params.toString());
              const json = await res.json();

              if (!json.ok) throw new Error(json.error || "Error en cargaMasivaPmr");

              totalPasajeros           += json.totalPasajeros || chunk.length;
              totalVuelosNuevos       += json.vuelosNuevos || 0;
              totalVuelosActualizados += json.vuelosActualizados || 0;

              exito = true;
            } catch (err) {
              console.warn(`Error al enviar chunk ${inicio}-${fin} (intento ${intentos})`, err);
              if (intentos >= maxRetries) {
                throw new Error(
                  `Se perdi√≥ la conexi√≥n al enviar los registros ${inicio}-${fin}. ` +
                  `Se intent√≥ ${maxRetries} veces sin √©xito. ` +
                  `Hasta ahora se cargaron ${totalPasajeros} pasajeros, ` +
                  `${totalVuelosNuevos} vuelos nuevos y ` +
                  `${totalVuelosActualizados} vuelos actualizados. ` +
                  `Detalle √∫ltimo error: ${err.message || err}`
                );
              }
              await new Promise(r => setTimeout(r, 1000));
            }
          }
        }

        msg.textContent =
          `Carga masiva completada. ` +
          `Pasajeros: ${totalPasajeros}, ` +
          `Vuelos nuevos: ${totalVuelosNuevos}, ` +
          `Vuelos actualizados: ${totalVuelosActualizados}.`;
        msg.className = "msg ok";

        input.value = "";
        await cargarDatos();

      } catch (error) {
        console.error(error);
        msg.textContent = "Error al procesar el archivo: " + (error.message || error);
        msg.className = "msg err";
      } finally {
        btn.disabled = false;
      }
    };

    reader.readAsArrayBuffer(file);
  }

  async function accionCrearPasajero() {
    const msg = document.getElementById("msg-crear-pmr");
    msg.textContent = "";
    msg.className = "msg";

    const vueloSel = document.getElementById("crear-pmr-vuelo").value;
    const nombre   = document.getElementById("crear-pmr-nombre").value.trim();
    const tipoAsis = document.getElementById("crear-pmr-tipo").value.trim();
    const edad     = document.getElementById("crear-pmr-edad").value;
    const origen   = document.getElementById("crear-pmr-origen").value.trim();
    const destino  = document.getElementById("crear-pmr-destino").value.trim();
    const obs      = document.getElementById("crear-pmr-obs").value.trim();

    if (!vueloSel || !nombre || !tipoAsis) {
      msg.textContent = "Ingresa al menos vuelo, nombre y tipo de asistencia.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","crearPasajero");
    params.append("vuelo",vueloSel);
    params.append("nombre",nombre);
    params.append("tipoAsistencia",tipoAsis);
    if (edad)    params.append("edad",edad);
    if (origen)  params.append("origen",origen);
    if (destino) params.append("destino",destino);
    if (obs)     params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al crear pasajero");

      msg.textContent = "Pasajero PMR creado correctamente. ID: " + json.idPmr;
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al crear pasajero: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  async function accionAsignarPmr() {
    const msg = document.getElementById("msg-asignar-pmr");
    msg.textContent = "";
    msg.className = "msg";

    const idPmr    = document.getElementById("asig-select-pmr").value;
    const idAgente = document.getElementById("asig-select-agente").value;
    const tipoT    = document.getElementById("asig-tipo-traslado").value;
    const obs      = document.getElementById("asig-obs").value.trim();

    if (!idPmr) {
      msg.textContent = "Selecciona un pasajero PMR.";
      msg.className = "msg err";
      return;
    }
    if (!idAgente) {
      msg.textContent = "Selecciona un agente disponible.";
      msg.className = "msg err";
      return;
    }
    if (!tipoT) {
      msg.textContent = "Selecciona un tipo de traslado.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","asignarPmrAgente");
    params.append("idPmr",idPmr);
    params.append("idAgente",idAgente);
    params.append("tipoTraslado",tipoT);
    params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al asignar");

      msg.textContent = "Asignaci√≥n creada correctamente (PMR/Agente quedan En asignaci√≥n, espera aceptaci√≥n 7 min).";
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al asignar PMR: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  /* --------- UI: MEN√öS DE ACCIONES (4 principales + submen√∫s) --------- */
  function activarMenuAccion(menuId) {
    document.querySelectorAll(".main-action-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".action-menu").forEach(m => m.classList.remove("active"));

    const btn = document.querySelector(`.main-action-btn[data-menu="${menuId}"]`);
    const menu = document.getElementById(menuId);
    if (btn) btn.classList.add("active");
    if (menu) menu.classList.add("active");
  }

  function activarSubAccion(menuId, formId) {
    const menu = document.getElementById(menuId);
    if (!menu) return;

    menu.querySelectorAll(".sub-action-btn").forEach(b => b.classList.remove("active"));
    menu.querySelectorAll(".action-form").forEach(f => f.classList.add("hidden"));

    const btn = menu.querySelector(`.sub-action-btn[data-form="${formId}"]`);
    const form = document.getElementById(formId);

    if (btn) btn.classList.add("active");
    if (form) form.classList.remove("hidden");
  }

  /* --------- EVENTOS --------- */
  document.addEventListener("DOMContentLoaded", () => {
    // Vistas
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const vista = btn.dataset.view;
        document.querySelectorAll(".view-section").forEach(sec => sec.classList.remove("active"));
        document.getElementById("view-" + vista).classList.add("active");

        renderVistaActual();
      });
    });

    // 4 acciones principales
    document.querySelectorAll(".main-action-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const menuId = btn.dataset.menu;
        activarMenuAccion(menuId);

        // por defecto: activar primera sub-acci√≥n del men√∫ abierto
        const menu = document.getElementById(menuId);
        const firstSub = menu ? menu.querySelector(".sub-action-btn") : null;
        if (firstSub) activarSubAccion(menuId, firstSub.dataset.form);
      });
    });

    // sub acciones
    document.querySelectorAll(".sub-action-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const formId = btn.dataset.form;
        const menu = btn.closest(".action-menu");
        if (!menu) return;
        activarSubAccion(menu.id, formId);
      });
    });

    // Acciones
    document.getElementById("btn-crear-vuelo").addEventListener("click", accionCrearVuelo);
    document.getElementById("btn-modificar-vuelo").addEventListener("click", accionModificarVuelo);
    document.getElementById("btn-carga-masiva").addEventListener("click", accionCargaMasiva);
    document.getElementById("btn-crear-pmr").addEventListener("click", accionCrearPasajero);
    document.getElementById("btn-asignar-pmr").addEventListener("click", accionAsignarPmr);

    // Asignaci√≥n (cambios para preview y agentes)
    document.getElementById("asig-select-pmr").addEventListener("change", refrescarAgentesParaPmr);
    document.getElementById("asig-tipo-traslado").addEventListener("change", actualizarPreviewOrigenDestino);

    document.getElementById("btn-actualizar").addEventListener("click", () => cargarDatos());

    // Filtros Vuelos
    document.getElementById("filtro-vuelo-num").addEventListener("input", renderVistaVuelos);
    document.getElementById("filtro-aerolinea").addEventListener("input", renderVistaVuelos);

    // Filtros PMR
    document.getElementById("filtro-pmr-vuelo").addEventListener("change", renderVistaPmr);
    document.getElementById("filtro-pmr-estado").addEventListener("change", renderVistaPmr);

    // Filtros Asignaciones
    document.getElementById("filtro-asig-vuelo-num").addEventListener("input", renderVistaAsignaciones);
    document.getElementById("filtro-asig-fecha").addEventListener("change", renderVistaAsignaciones);
    document.getElementById("filtro-asig-tipo").addEventListener("change", renderVistaAsignaciones);
    document.getElementById("filtro-asig-estado").addEventListener("change", renderVistaAsignaciones);

    // Estado inicial: men√∫ Vuelos / sub Crear vuelo
    activarMenuAccion("menu-vuelos");
    activarSubAccion("menu-vuelos", "form-crear-vuelo");

    cargarDatos();
  });
</script>
</body>
</html>

