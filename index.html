<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cargo Mobility PMR – Panel Supervisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Librería para leer Excel (.xlsx / .xls) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:Arial, sans-serif; background:#111827; color:#0b1020; }

    header{
      background:linear-gradient(90deg,#1e3a8a,#1d4ed8,#3b82f6);
      color:#fff; padding:10px 18px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 4px 14px rgba(0,0,0,.6);
      border-bottom:2px solid rgba(59,130,246,.7);
    }
    header .brand{display:flex;flex-direction:column;}
    header .brand-name{font-size:18px;font-weight:bold;letter-spacing:.03em;}
    header .brand-sub{font-size:11px;opacity:.9;}
    header .status{font-size:11px;text-align:right;opacity:.95;}

    .app{
      display:flex;
      height:calc(100vh - 52px);
      background:
        radial-gradient(circle at top left, rgba(59,130,246,.14), transparent 60%),
        radial-gradient(circle at bottom right, rgba(248,113,113,.15), transparent 55%),
        linear-gradient(135deg,#111827,#020617 55%,#1f2937);
    }

    .sidebar{
      width:320px;
      background:radial-gradient(circle at top,#1e3a8a,#1d4ed8 60%,#111827 100%);
      color:#e5e7eb;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
      border-right:1px solid rgba(59,130,246,.7);
      box-shadow:4px 0 20px rgba(0,0,0,.6);
    }

    .sidebar-section-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:#bfdbfe;
      margin-bottom:4px;
    }

    .nav{display:flex;flex-direction:column;gap:4px;}
    .nav-btn{
      border:none;border-radius:8px;
      background:linear-gradient(120deg,#7f1d1d,#b91c1c);
      color:#e5e7eb;
      padding:7px 10px;
      font-size:12px;text-align:left;
      cursor:pointer;
      transition:background .15s,transform .05s, box-shadow .15s, border .15s;
      box-shadow:0 2px 6px rgba(15,23,42,.7);
      border:1px solid rgba(254,226,226,.9);
    }
    .nav-btn:hover{ background:linear-gradient(120deg,#b91c1c,#ef4444); transform:translateY(-1px); box-shadow:0 4px 10px rgba(15,23,42,.8); }
    .nav-btn.active{ background:linear-gradient(120deg,#1d4ed8,#3b82f6); color:#fef2f2; font-weight:600; border:1px solid rgba(191,219,254,.9); box-shadow:0 4px 10px rgba(30,64,175,.8); }

    .actions-box{
      background:#0b1020;
      border-radius:14px;
      padding:10px;
      font-size:12px;
      border:1px solid rgba(248,113,113,.7);
      box-shadow:0 8px 22px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .actions-box::before{
      content:"";
      position:absolute;
      inset:0;
      background-image:
        linear-gradient(90deg, rgba(248,113,113,.18) 1px, transparent 1px),
        linear-gradient(180deg, rgba(248,113,113,.18) 1px, transparent 1px);
      background-size:20px 20px;
      opacity:.25;
      pointer-events:none;
    }
    .actions-box > *{position:relative;z-index:1;}

    .action-tabs{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:4px;margin-bottom:6px;
    }
    .action-tab-btn{
      border:none;border-radius:8px;
      background:rgba(15,23,42,.95);
      color:#e5e7eb;
      padding:4px 6px;
      font-size:11px;
      cursor:pointer;
      text-align:center;
      transition:background .15s, box-shadow .15s, transform .05s, border .15s;
      border:1px solid rgba(248,113,113,.7);
    }
    .action-tab-btn:hover{ background:linear-gradient(135deg,#b91c1c,#ef4444); box-shadow:0 3px 8px rgba(15,23,42,.9); transform:translateY(-1px); }
    .action-tab-btn.active{ background:linear-gradient(135deg,#1d4ed8,#3b82f6); color:#fef2f2; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,.8); border:1px solid rgba(191,219,254,.95); }

    .action-form{
      margin-top:6px;border-radius:10px;
      background:radial-gradient(circle at top left,#0f172a,#020617 60%,#020617 100%);
      padding:8px;
      box-shadow:inset 0 0 0 1px rgba(248,113,113,.7);
    }
    .action-form.hidden{display:none;}

    label{ display:block; margin-top:6px; font-size:11px; color:#e5e7eb; }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
      width:100%; margin-top:2px; padding:4px 6px;
      border-radius:6px; border:1px solid #374151;
      background:#020617; color:#e5e7eb; font-size:12px; outline:none;
      transition:border .12s, box-shadow .12s, background .12s;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, input[type="time"]:focus, select:focus, textarea:focus{
      border-color:#ef4444; box-shadow:0 0 0 1px rgba(248,113,113,.85); background:#020617;
    }
    textarea{resize:vertical;min-height:52px;}
    input[type="file"]{
      width:100%; margin-top:4px; padding:4px; border-radius:6px;
      border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:12px;
    }

    .btn-submit{
      margin-top:8px; padding:7px 10px;
      border:none; border-radius:999px;
      background:linear-gradient(120deg,#b91c1c,#ef4444);
      color:#fef2f2;
      font-size:12px; cursor:pointer;
      box-shadow:0 3px 8px rgba(15,23,42,.9);
      transition:background .15s, box-shadow .15s, transform .05s;
      width:100%; text-transform:uppercase; letter-spacing:.08em; font-weight:600;
    }
    .btn-submit:hover{ background:linear-gradient(120deg,#ef4444,#f97373); box-shadow:0 5px 12px rgba(15,23,42,1); transform:translateY(-1px); }
    .btn-submit:disabled{ opacity:.6; cursor:default; box-shadow:none; }

    .helper-text{ font-size:10px; color:#9ca3af; margin-top:4px; }
    .msg{font-size:11px;margin-top:4px;color:#e5e7eb;}
    .msg.ok{color:#4ade80;}
    .msg.err{color:#fb923c;}

    .main{
      flex:1;
      padding:10px 14px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:
        radial-gradient(circle at top,#1d4ed8 0,#111827 45%),
        radial-gradient(circle at bottom,#7f1d1d 0,#020617 55%);
    }

    .view-header{
      display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;
      color:#e5e7eb;
    }
    .view-title{
      font-size:17px; font-weight:700; letter-spacing:.04em; text-transform:uppercase;
    }
    .view-filters{display:flex;gap:6px;flex-wrap:wrap;font-size:11px;align-items:center;}

    .chip{
      border-radius:999px;
      border:1px solid rgba(59,130,246,.9);
      background:linear-gradient(120deg,rgba(37,99,235,.25),rgba(248,113,113,.15));
      padding:2px 10px;
      color:#fef2f2;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 2px 6px rgba(15,23,42,.8);
    }
    .chip-label{font-weight:700;text-transform:uppercase;font-size:10px;}

    .view-container{
      background:radial-gradient(circle at top left,#020617,#020617 35%,#0b1120 100%);
      border-radius:14px;
      padding:10px;
      box-shadow:0 14px 40px rgba(0,0,0,.85);
      border-top:2px solid rgba(59,130,246,.9);
      border-left:1px solid rgba(248,113,113,.7);
    }

    .empty-state{
      padding:16px;
      font-size:12px;
      color:#9ca3af;
      text-align:center;
      border-radius:10px;
      border:1px dashed rgba(248,113,113,.7);
      background:rgba(15,23,42,.9);
      margin-top:6px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:6px;
      color:#e5e7eb;
      border-radius:10px;
      overflow:hidden;
    }
    th,td{
      border:1px solid rgba(30,64,175,.7);
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:linear-gradient(90deg,#b91c1c,#dc2626,#f97373);
      color:#fefce8;
      position:sticky;
      top:0;
      z-index:1;
      border-bottom:2px solid rgba(59,130,246,.85);
      text-transform:uppercase;
      letter-spacing:.06em;
      font-size:10px;
    }
    tr:nth-child(even){ background:rgba(15,23,42,.9); }
    tr:nth-child(odd){ background:rgba(17,24,39,.95); }
    tr:hover{ background:radial-gradient(circle at left,#2563eb 0,transparent 55%); }

    .view-section{display:none;}
    .view-section.active{display:block;}

    @media(max-width:900px){
      .app{flex-direction:column;height:auto;}
      .sidebar{width:100%;}
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <span class="brand-name">Cargo Mobility – PMR</span>
    <span class="brand-sub">Panel Supervisor / CDO</span>
  </div>
  <div class="status">
    <div id="api-status">Conectando con API...</div>
    <div id="last-update">Última actualización: --</div>
  </div>
</header>

<div class="app">
  <aside class="sidebar">
    <div>
      <div class="sidebar-section-title">Vistas</div>
      <div class="nav">
        <button class="nav-btn active" data-view="vuelos">Vuelos</button>
        <button class="nav-btn" data-view="pmr">Pasajeros PMR</button>
        <button class="nav-btn" data-view="asignaciones">Asignaciones</button>
        <button class="nav-btn" data-view="agentes">Agentes</button>
      </div>
    </div>

    <div>
      <div class="sidebar-section-title">Acciones</div>
      <div class="actions-box">
        <div class="action-tabs">
          <button class="action-tab-btn active" data-target="form-crear-vuelo">Crear vuelo</button>
          <button class="action-tab-btn" data-target="form-modificar-vuelo">Modificar vuelo</button>
          <button class="action-tab-btn" data-target="form-carga-masiva">Carga masiva</button>
          <button class="action-tab-btn" data-target="form-carga-ostrum">Carga Ostrum</button>
          <button class="action-tab-btn" data-target="form-crear-pmr">Crear pasajero</button>
          <button class="action-tab-btn" data-target="form-asignar-pmr">Asignar PMR</button>
        </div>

        <div id="form-crear-vuelo" class="action-form">
          <label>Fecha vuelo <input type="date" id="crear-fecha" /></label>
          <label>Hora programada <input type="time" id="crear-hora" /></label>
          <label>Aerolínea <input type="text" id="crear-aerolinea" placeholder="Sky, LATAM, etc." /></label>
          <label>Número de vuelo <input type="text" id="crear-numero" placeholder="LA345" /></label>
          <label>Terminal
            <select id="crear-terminal">
              <option value="">— Seleccionar —</option>
              <option value="Nacional">Nacional</option>
              <option value="Internacional">Internacional</option>
            </select>
          </label>
          <label>Puerta <input type="text" id="crear-puerta" placeholder="1–13" /></label>
          <label>Espigón <input type="text" id="crear-espigon" placeholder="A–F" /></label>
          <label>Tipo de avión
            <select id="crear-tipo-avion">
              <option value="">— Seleccionar —</option>
              <option value="NB">NB</option>
              <option value="WB">WB</option>
            </select>
          </label>
          <label>Origen (código) <input type="text" id="crear-origen-vuelo" placeholder="SCL, LIM, etc." /></label>
          <label>Destino (código) <input type="text" id="crear-destino-vuelo" placeholder="SCL, LIM, etc." /></label>
          <label>Cant. pasajeros PMR <input type="number" id="crear-cant-pmr" min="0" value="0" /></label>
          <label>Tipo de servicio
            <select id="crear-tipo-servicio">
              <option value="">— Seleccionar —</option>
              <option value="Embarque">Embarque</option>
              <option value="Desembarque">Desembarque</option>
            </select>
          </label>
          <label>Estado de vuelo
            <select id="crear-estado-vuelo">
              <option value="Programado">Programado</option>
              <option value="Modificado">Modificado</option>
              <option value="Retrasado">Retrasado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </label>
          <label>Observaciones <textarea id="crear-obs"></textarea></label>
          <button class="btn-submit" id="btn-crear-vuelo">Guardar vuelo</button>
          <div class="helper-text">Al crear, se generará un ID_Vuelo único.</div>
          <div class="msg" id="msg-crear-vuelo"></div>
        </div>

        <div id="form-modificar-vuelo" class="action-form hidden">
          <label>Seleccionar vuelo (sólo hoy)
            <select id="modificar-id-vuelo"><option value="">— Seleccionar —</option></select>
          </label>
          <label>Nueva fecha <input type="date" id="modificar-fecha" /></label>
          <label>Nueva hora <input type="time" id="modificar-hora" /></label>
          <label>Nueva puerta <input type="text" id="modificar-puerta" /></label>
          <label>Nuevo espigón <input type="text" id="modificar-espigon" /></label>
          <button class="btn-submit" id="btn-modificar-vuelo">Modificar vuelo</button>
          <div class="helper-text">Sólo se permiten modificaciones en vuelos del día actual.</div>
          <div class="msg" id="msg-modificar-vuelo"></div>
        </div>

        <div id="form-carga-masiva" class="action-form hidden">
          <label>Archivo Excel (.xlsx / .xls)
            <input type="file" id="input-carga-masiva" accept=".xlsx,.xls" />
          </label>
          <div class="helper-text">
            Columnas A–O: Nombre, RUT, Edad, Fecha_Vuelo, Hora, Tipo_Vuelo, Vuelo, Tipo_Avion, Aerolínea,
            Terminal, Origen, Destino, Puerta, Espigón, Tipo_PMR.
          </div>
          <button class="btn-submit" id="btn-carga-masiva">Procesar archivo</button>
          <div class="msg" id="msg-carga-masiva"></div>
        </div>

        <div id="form-carga-ostrum" class="action-form hidden">
          <label>Tipo de carga Ostrum
            <select id="ostrum-tipo-operacion">
              <option value="Embarque">Embarque (Salidas)</option>
              <option value="Desembarque">Desembarque (Arribos)</option>
            </select>
          </label>
          <label>Archivo Ostrum (Excel o CSV)
            <input type="file" id="input-carga-ostrum" accept=".xlsx,.xls,.csv" />
          </label>
          <div class="helper-text">
            Esta carga crea <b>placeholders</b> PMR desde la columna PMR (ej: <i>10 - S(3) R(7)</i>).
            Se generan RUT determinísticos: <b>OSTRUM-YYYYMMDD-VUELO-TIPO-##</b>.
            Puerta/Espigón/Hora se toman desde Ostrum (prioridad: ACT ➜ EST ➜ SCH).
          </div>
          <button class="btn-submit" id="btn-carga-ostrum">Procesar Ostrum</button>
          <div class="msg" id="msg-carga-ostrum"></div>
        </div>

        <div id="form-crear-pmr" class="action-form hidden">
          <label>Vuelo (número + fecha)
            <select id="crear-pmr-vuelo"><option value="">— Seleccionar vuelo —</option></select>
          </label>
          <label>Nombre pasajero PMR <input type="text" id="crear-pmr-nombre" placeholder="Nombre completo" /></label>
          <label>Tipo de asistencia <input type="text" id="crear-pmr-tipo" placeholder="WHL_SLC, etc." /></label>
          <label>Edad <input type="number" id="crear-pmr-edad" min="0" /></label>
          <label>Origen (código) <input type="text" id="crear-pmr-origen" placeholder="SCL, LIM, etc." /></label>
          <label>Destino (código) <input type="text" id="crear-pmr-destino" placeholder="SCL, LIM, etc." /></label>
          <label>Observaciones <textarea id="crear-pmr-obs"></textarea></label>

          <button class="btn-submit" id="btn-crear-pmr">Crear pasajero PMR</button>
          <div class="helper-text">El pasajero se crea <b>En espera</b> y se actualiza Cant PMR del vuelo.</div>
          <div class="msg" id="msg-crear-pmr"></div>
        </div>

        <div id="form-asignar-pmr" class="action-form hidden">
          <label>Pasajero PMR (En espera)
            <select id="asig-select-pmr"><option value="">— Seleccionar PMR —</option></select>
          </label>

          <label>Agente disponible (misma terminal)
            <select id="asig-select-agente"><option value="">— Selecciona primero un PMR —</option></select>
          </label>

          <label>Tipo de traslado
            <select id="asig-tipo-traslado">
              <option value="">— Seleccionar —</option>
              <option value="Ultima Milla">Última Milla</option>
              <option value="Tramo Completo">Tramo Completo</option>
            </select>
          </label>

          <label>Origen (auto) <input type="text" id="asig-origen" readonly /></label>
          <label>Destino (auto) <input type="text" id="asig-destino" readonly /></label>
          <div class="helper-text">
            Origen/destino se calculan automáticamente según tipo de servicio del vuelo, tipo de asistencia y tipo de traslado.
          </div>

          <label>Observaciones <textarea id="asig-obs"></textarea></label>
          <button class="btn-submit" id="btn-asignar-pmr">Asignar</button>
          <div class="helper-text">Se filtrarán agentes "Disponibles" en la misma terminal del vuelo del PMR.</div>
          <div class="msg" id="msg-asignar-pmr"></div>
        </div>
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="view-header">
      <div class="view-title" id="view-title">Vuelos</div>
      <div class="view-filters">
        <button class="btn-submit" id="btn-actualizar" style="width:auto;padding:4px 10px;font-size:11px;">Actualizar datos</button>
        <div class="chip" id="auto-refresh-box" style="display:none;">
          <span class="chip-label">Auto-refresco</span>
          <span>en <span id="auto-refresh-label">45</span> s</span>
        </div>
        <div class="chip" id="chip-info-vista">
          <span class="chip-label">Vuelos:</span>
          <span>Mostrando hoy y mañana</span>
        </div>
      </div>
    </div>

    <div class="view-container">
      <section id="view-vuelos" class="view-section active">
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:150px;">
            <label>Filtro N° vuelo <input type="text" id="filtro-vuelo-num" placeholder="Ej: LA345" /></label>
          </div>
          <div style="min-width:150px;">
            <label>Aerolínea (autocompletar)
              <input type="text" id="filtro-aerolinea" list="lista-aerolineas" placeholder="Todas" />
              <datalist id="lista-aerolineas"></datalist>
            </label>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID Vuelo</th><th>Fecha</th><th>Hora</th><th>Aerolínea</th><th>N° Vuelo</th>
              <th>Terminal</th><th>Puerta</th><th>Espigón</th><th>Cant PMR</th><th>Tipo servicio</th>
              <th>Estado</th><th>Tipo</th><th>Origen</th><th>Destino</th><th>Obs</th>
            </tr>
          </thead>
          <tbody id="tbody-vuelos"></tbody>
        </table>
        <div class="empty-state" id="empty-vuelos" style="display:none;">No hay vuelos para hoy o mañana (solo próximas horas, con PMR en espera).</div>
      </section>

      <section id="view-pmr" class="view-section">
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:220px;">
            <label>Filtrar por Vuelo (N° + fecha)
              <select id="filtro-pmr-vuelo"><option value="">Todos</option></select>
            </label>
          </div>
          <div style="min-width:180px;">
            <label>Filtrar por Estado
              <select id="filtro-pmr-estado"><option value="">Todos</option></select>
            </label>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID PMR</th><th>Vuelo</th><th>Nombre</th><th>Tipo asistencia</th><th>Edad</th>
              <th>Origen</th><th>Destino</th><th>Estado</th><th>ID Agente</th>
              <th>Hora inicio</th><th>Hora fin</th><th>Obs</th>
            </tr>
          </thead>
          <tbody id="tbody-pmr"></tbody>
        </table>
        <div class="empty-state" id="empty-pmr" style="display:none;">No hay pasajeros PMR para los filtros seleccionados.</div>
      </section>

      <section id="view-asignaciones" class="view-section">
        <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;margin-bottom:4px;">
          <div style="min-width:150px;"><label>Filtro N° vuelo <input type="text" id="filtro-asig-vuelo-num" placeholder="Ej: LA345" /></label></div>
          <div style="min-width:150px;"><label>Fecha asignación <input type="date" id="filtro-asig-fecha" /></label></div>
          <div style="min-width:150px;"><label>Tipo traslado <select id="filtro-asig-tipo"><option value="">Todos</option></select></label></div>
          <div style="min-width:150px;"><label>Estado <select id="filtro-asig-estado"><option value="">Todos</option></select></label></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>ID Asignación</th><th>ID Vuelo</th><th>ID PMR</th><th>ID Agente</th><th>Fecha</th>
              <th>Hora Asig.</th><th>Hora inicio</th><th>Hora fin</th><th>Estado</th><th>Tipo traslado</th>
              <th>Origen</th><th>Destino</th><th>Justificación cancelación</th><th>Hora límite</th>
            </tr>
          </thead>
          <tbody id="tbody-asignaciones"></tbody>
        </table>
        <div class="empty-state" id="empty-asignaciones" style="display:none;">No hay asignaciones registradas para los filtros seleccionados.</div>
      </section>

      <section id="view-agentes" class="view-section">
        <table>
          <thead>
            <tr>
              <th>ID Agente</th><th>Nombre</th><th>RUT</th><th>Teléfono</th><th>Estado</th>
              <th>Estado Servicio</th><th>Último Servicio</th><th>Observaciones</th><th>Ubicación</th>
            </tr>
          </thead>
          <tbody id="tbody-agentes"></tbody>
        </table>
        <div class="empty-state" id="empty-agentes" style="display:none;">No hay agentes configurados.</div>
      </section>
    </div>
  </main>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwFBHpIx-gQrVAvj5Vv-I-l1X3NR9MYbyTV9CtxgKCw7oPeuxIE5qrYx3eZdDoIroTE/exec";

  let cacheVuelos = [];
  let cachePasajeros = [];
  let cacheAsignaciones = [];
  let cacheAgentes = [];

  let autoRefreshInterval = null;
  let autoRefreshSeconds = 180;

  function iniciarAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshSeconds = 180;

    const box = document.getElementById("auto-refresh-box");
    const label = document.getElementById("auto-refresh-label");
    if (box) box.style.display = "none";

    autoRefreshInterval = setInterval(async () => {
      autoRefreshSeconds--;

      if (autoRefreshSeconds <= 0) {
        autoRefreshSeconds = 180;
        await cargarDatos(true);
      }

      if (!box || !label) return;

      if (autoRefreshSeconds <= 45) {
        box.style.display = "inline-flex";
        label.textContent = autoRefreshSeconds;
      } else {
        box.style.display = "none";
      }
    }, 1000);
  }

  /* --------- FECHA / HORA (✅ mismos FIX del código que sí funcionó) --------- */

  // ✅ FIX: soporta yyyy-mm-ddTHH:..Z sin corrimiento de día
  function parseFechaSolo(fecha) {
    if (!fecha) return null;
    if (fecha instanceof Date) return new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());

    const s = String(fecha).trim();

    // dd/mm/yyyy o dd-mm-yyyy
    let m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) return new Date(parseInt(m[3],10), parseInt(m[2],10)-1, parseInt(m[1],10));

    // yyyy-mm-dd o yyyy/mm/dd
    m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));

    // yyyy-mm-ddTHH:... (ISO)
    m = s.match(/^(\d{4})-(\d{2})-(\d{2})T/);
    if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));

    const d = new Date(s);
    if (!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    return null;
  }

  function hoyTrunc() {
    const d = new Date();
    return new Date(d.getFullYear(), d.getMonth(), d.getDate());
  }

  function addDias(date, dias) {
    const d = new Date(date);
    d.setDate(d.getDate() + dias);
    return d;
  }

  function formatearHora(horaRaw) {
    if (!horaRaw) return "";
    if (horaRaw instanceof Date) {
      const hh = String(horaRaw.getHours()).padStart(2,"0");
      const mm = String(horaRaw.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    const s = String(horaRaw);
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,"0")}:${m[2]}`;
    return s;
  }

  // ✅ FIX TZ: siempre devuelve yyyy-mm-dd SIN “día anterior”
  function normalizarFechaExcel(valor) {
    if (valor === null || valor === undefined || valor === "") return "";

    // Serial Excel
    if (typeof valor === "number") {
      const ms = Math.round((valor - 25569) * 86400 * 1000);
      const d = new Date(ms);
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth() + 1).padStart(2,"0");
      const dd = String(d.getUTCDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    // Date object
    if (valor instanceof Date) {
      const yyyy = valor.getUTCFullYear();
      const mm = String(valor.getUTCMonth() + 1).padStart(2,"0");
      const dd = String(valor.getUTCDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    const s = String(valor).trim();

    // ISO datetime
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})T/);
    if (m) return `${m[1]}-${m[2]}-${m[3]}`;

    // yyyy-mm-dd / yyyy/mm/dd
    m = s.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
    if (m) return `${m[1]}-${m[2].padStart(2,"0")}-${m[3].padStart(2,"0")}`;

    // dd-mm-yyyy / dd/mm/yyyy
    m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
    if (m) return `${m[3]}-${m[2].padStart(2,"0")}-${m[1].padStart(2,"0")}`;

    const d = new Date(s);
    if (!isNaN(d)) {
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,"0");
      const dd = String(d.getUTCDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }
    return s;
  }

  function normalizarHoraExcel(valor) {
    if (valor === null || valor === undefined || valor === "") return "";
    if (typeof valor === "number") {
      const totalSeconds = Math.round(valor * 86400);
      const hh = String(Math.floor(totalSeconds / 3600) % 24).padStart(2,"0");
      const mm = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2,"0");
      return `${hh}:${mm}`;
    }
    const s = String(valor).trim();
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if (m) return `${m[1].padStart(2,"0")}:${m[2]}`;
    return s;
  }

  // ✅ KEY de vuelo (número + fecha)
  function vueloKey(numeroVuelo, fechaAny) {
    const ymd = normalizarFechaExcel(fechaAny);
    return `${String(numeroVuelo || "").trim()}||${ymd}`;
  }
  function vueloKeyFromVuelo(v) {
    return vueloKey(v?.numeroVuelo, v?.fecha);
  }

  // ✅ PMR key (vuelo + fechaVuelo si existe; si no, usa vuelo.fecha del match)
  function pmrFechaYmd(p) {
    const f = p?.fechaVuelo || p?.fecha || p?.fechaVueloPmr || p?.fecha_vuelo || "";
    if (f) return normalizarFechaExcel(f);
    const v = getVueloDePmr(p);
    return v ? normalizarFechaExcel(v.fecha) : "";
  }
  function pmrKey(p) {
    const ymd = pmrFechaYmd(p);
    return ymd ? `${String(p.vuelo || "").trim()}||${ymd}` : String(p.vuelo || "").trim();
  }

  // ✅ DateTime (fecha + hora) para filtrar "solo próximas horas"
  function obtenerDateTimeVuelo(v) {
    const f = parseFechaSolo(v?.fecha);
    if (!f) return null;

    const h = formatearHora(v?.horaProgramada);
    if (!h) return new Date(f.getFullYear(), f.getMonth(), f.getDate(), 23, 59, 59, 999);

    const m = String(h).match(/^(\d{1,2}):(\d{2})$/);
    if (!m) return new Date(f.getFullYear(), f.getMonth(), f.getDate(), 23, 59, 59, 999);

    const hh = parseInt(m[1], 10);
    const mm = parseInt(m[2], 10);
    if (isNaN(hh) || isNaN(mm)) return new Date(f.getFullYear(), f.getMonth(), f.getDate(), 23, 59, 59, 999);

    return new Date(f.getFullYear(), f.getMonth(), f.getDate(), hh, mm, 0, 0);
  }

  function vueloEsFuturo(v) {
    const dt = obtenerDateTimeVuelo(v);
    if (!dt) return false;
    const ahora = new Date();
    return dt.getTime() >= ahora.getTime();
  }

  /* --------- ORIGEN/DESTINO FRONT --------- */
  function calcularOrigenDestinoFront(tipoServicioVuelo, tipoAsistencia, tipoTraslado, puerta, espigon) {
    const ts = (tipoServicioVuelo || "").toString().toLowerCase().trim();
    const ta = (tipoAsistencia || "").toString().toUpperCase().trim();
    const tt = (tipoTraslado || "").toString().toLowerCase().trim();

    const puertaEspigon   = ((puerta || "") + (espigon || "")).trim();
    const puertaEmbarque  = puertaEspigon ? `Puerta Embarque ${puertaEspigon}` : "Puerta Embarque";

    const esUltimaMilla   = tt.includes("ultima") || tt.includes("última");
    const esTramoCompleto = tt.includes("tramo");

    const esWHC          = (ta === "WHC");
    const etiquetaAvion  = esWHC ? "Asiento Avión" : "Puerta Avión";

    let origen  = "";
    let destino = "";

    if (esUltimaMilla) {
      if (ts === "embarque") { origen = puertaEmbarque; destino = etiquetaAvion; }
      else if (ts === "desembarque") { origen = etiquetaAvion; destino = puertaEmbarque; }
    } else if (esTramoCompleto) {
      if (ts === "embarque") { origen = "Elección del Pasajero"; destino = etiquetaAvion; }
      else if (ts === "desembarque") { origen = etiquetaAvion; destino = "Elección del Pasajero"; }
    }
    return { origen, destino };
  }

  /* ----------------- OSTRUM helpers ----------------- */
  function limpiarStr(v){ return (v === null || v === undefined) ? "" : String(v).trim(); }
  function detectarSeparadorCsv(text){
    const sample=(text||"").split(/\r?\n/).slice(0,10).join("\n");
    const commas=(sample.match(/,/g)||[]).length;
    const semis=(sample.match(/;/g)||[]).length;
    return semis>commas?";":",";
  }
  function parseCSV(text){
    const sep=detectarSeparadorCsv(text);
    const rows=[]; let row=[]; let cur=""; let inQuotes=false;
    function pushCell(){ row.push(cur); cur=""; }
    function pushRow(){ rows.push(row); row=[]; }
    for (let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if (ch==='"'){
        if (inQuotes && next==='"'){ cur+='"'; i++; }
        else inQuotes=!inQuotes;
        continue;
      }
      if (!inQuotes && ch===sep){ pushCell(); continue; }
      if (!inQuotes && (ch==="\n"||ch==="\r")){
        if (ch==="\r"&&next==="\n") i++;
        pushCell(); pushRow(); continue;
      }
      cur+=ch;
    }
    pushCell(); pushRow();
    return rows.filter(r=>r.some(c=>String(c||"").trim()!==""));
  }
  function getColIndex(headers,candidates){
    const norm=(s)=>String(s||"").toLowerCase().replace(/\s+/g," ").trim();
    const hs=headers.map(h=>norm(h));
    for (const cand of candidates){
      const c=norm(cand); const idx=hs.indexOf(c);
      if (idx!==-1) return idx;
    }
    for (let i=0;i<hs.length;i++){
      for (const cand of candidates){
        const c=norm(cand);
        if (c && hs[i].includes(c)) return i;
      }
    }
    return -1;
  }
  function extraerAerolineaDesdeVuelo(vuelo){
    const m=String(vuelo||"").match(/^([A-Za-z]{2,3})/);
    return m?m[1].toUpperCase():"";
  }
  function normalizarTerminalOstrum(term){
    const t=limpiarStr(term).toUpperCase();
    if (t==="T1") return "Nacional";
    if (t==="T2") return "Internacional";
    if (t.toLowerCase()==="nacional") return "Nacional";
    if (t.toLowerCase()==="internacional") return "Internacional";
    return limpiarStr(term);
  }
  function parseFechaOstrumToYmd(valor){
    if (valor===null||valor===undefined||valor==="") return "";
    if (typeof valor==="number" || valor instanceof Date) return normalizarFechaExcel(valor);

    const s0=String(valor).trim();
    const byNormal=normalizarFechaExcel(s0);
    if (/^\d{4}-\d{2}-\d{2}$/.test(byNormal)) return byNormal;

    const s=s0.replace(/,/g," ").replace(/\s+/g," ").trim();
    const m=s.match(/^(\d{1,2})[ \-\/]?([A-Za-zÁÉÍÓÚáéíóú]{3,})[ \-\/]?(\d{4})?$/);
    if (m){
      const dd=String(parseInt(m[1],10)).padStart(2,"0");
      const monTxt=m[2].toLowerCase();
      const map={ jan:1,january:1,ene:1,enero:1, feb:2,february:2, mar:3,march:3, apr:4,april:4,abr:4,
        may:5,mayo:5, jun:6,june:6, jul:7,july:7, aug:8,august:8,ago:8,
        sep:9,sept:9,september:9,set:9, oct:10,october:10, nov:11,november:11, dec:12,december:12,dic:12,diciembre:12
      };
      const key=monTxt.slice(0,3);
      const mmNum=map[monTxt]||map[key];
      if (!mmNum) return "";
      const today=new Date();
      let yyyy=m[3]?parseInt(m[3],10):today.getFullYear();
      if (!m[3]){
        const todayM=today.getMonth()+1;
        if (todayM>=11 && mmNum<=3) yyyy=yyyy+1;
      }
      const mm=String(mmNum).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    const d=new Date(s0);
    if (!isNaN(d)) return normalizarFechaExcel(d);
    return "";
  }
  function elegirHoraOstrum(row,idxAct,idxEst,idxSch){
    const act=idxAct>=0?row[idxAct]:"";
    const est=idxEst>=0?row[idxEst]:"";
    const sch=idxSch>=0?row[idxSch]:"";
    const v=(act && String(act).trim()!=="-"?act:(est && String(est).trim()!=="-"?est:(sch && String(sch).trim()!=="-"?sch:"")));
    return normalizarHoraExcel(v);
  }
  function parsePmrBreakdown(pmrRaw){
    const s=limpiarStr(pmrRaw); if (!s) return [];
    const right=s.includes("-")?s.split("-").slice(1).join("-").trim():s.trim();
    if (!right) return [];
    const tokens=right.split(/\s+/).map(t=>t.trim()).filter(Boolean);
    const tipos=[];
    for (const t of tokens){
      const m=t.match(/^([A-Za-z]+)\((\d+)\)$/);
      if (!m) continue;
      const code=m[1].toUpperCase();
      const n=parseInt(m[2],10);
      if (!n || n<=0) continue;
      const tipo=("WH"+code);
      for (let i=0;i<n;i++) tipos.push(tipo);
    }
    return tipos;
  }
  function construirRutOstrum(ymd,vuelo,tipo,nro2){
    const yyyymmdd=String(ymd||"").replace(/-/g,"");
    return `OSTRUM-${yyyymmdd}-${String(vuelo||"").trim()}-${String(tipo||"").trim()}-${String(nro2).padStart(2,"0")}`;
  }

  /* --------- MATCH VUELO DE PMR (✅ PRIMERO POR idVuelo, LUEGO POR número+fecha) --------- */
  function getVueloDePmr(pmr) {
    if (!pmr) return null;

    // 1) exacto por idVuelo
    const idv = pmr.idVuelo || pmr.id_vuelo || "";
    if (idv) {
      const exactId = cacheVuelos.find(v => String(v.idVuelo) === String(idv));
      if (exactId) return exactId;
    }

    // 2) match por (numero + fechaVuelo)
    const num = pmr.vuelo ? String(pmr.vuelo).trim() : "";
    if (!num) return null;

    const fP = pmr.fechaVuelo || pmr.fecha || pmr.fechaVueloPmr || pmr.fecha_vuelo || "";
    const fNorm = fP ? normalizarFechaExcel(fP) : "";

    if (fNorm) {
      const exact = cacheVuelos.find(v =>
        String(v.numeroVuelo).trim() === num &&
        normalizarFechaExcel(v.fecha) === fNorm
      );
      if (exact) return exact;
    }

    // 3) fallback hoy/mañana
    const hoy = hoyTrunc();
    const manana = addDias(hoy,1);
    const candidates = cacheVuelos.filter(v => String(v.numeroVuelo).trim() === num);

    const best = candidates.find(v => {
      const f = parseFechaSolo(v.fecha);
      if (!f) return false;
      return f.getTime() === hoy.getTime() || f.getTime() === manana.getTime();
    });

    return best || candidates[0] || null;
  }

  function agentesDisponiblesEnTerminal(terminal) {
    const term = String(terminal || "").toLowerCase().trim();
    return cacheAgentes.filter(a => {
      const est = String(a.estadoServicio || a.estado || "").toLowerCase().trim();
      if (est !== "disponible") return false;
      if (!term) return true;
      const ub = String(a.ubicacion || "").toLowerCase().trim();
      return ub === term;
    });
  }

  /* --------- CARGA DE DATOS --------- */
  async function cargarDatos(silencioso = false) {
    const apiStatus = document.getElementById("api-status");
    const lastUpdate = document.getElementById("last-update");
    apiStatus.textContent = "Conectando con API...";

    try {
      const res = await fetch(API_URL + "?action=listAll");
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); }
      catch (e) { throw new Error("Respuesta no es JSON. Revisa permisos/deploy del WebApp."); }

      if (!json.ok) throw new Error(json.error || "Error en listAll");

      cacheVuelos        = json.vuelos || [];
      cachePasajeros     = json.pasajeros || [];
      cacheAsignaciones  = json.asignaciones || [];
      cacheAgentes       = json.agentes || [];

      apiStatus.textContent = "Conectado a la API";
      const ahora = new Date();
      lastUpdate.textContent = "Última actualización: " +
        ahora.toLocaleTimeString("es-CL", {hour:"2-digit", minute:"2-digit"});

      renderVistaActual();
      llenarCombosAcciones();
      iniciarAutoRefresh();
    } catch (err) {
      console.error(err);
      apiStatus.textContent = "Error al conectar con la API";
      if (!silencioso) alert("Error al cargar datos: " + (err.message || err));
    }
  }

  /* --------- RENDERIZADO DE VISTAS --------- */
  function renderVistaActual() {
    const btnActivo = document.querySelector(".nav-btn.active");
    const vista = btnActivo ? btnActivo.dataset.view : "vuelos";

    if (vista === "vuelos") renderVistaVuelos();
    else if (vista === "pmr") renderVistaPmr();
    else if (vista === "asignaciones") renderVistaAsignaciones();
    else if (vista === "agentes") renderVistaAgentes();
  }

  function renderVistaVuelos() {
    const tbody = document.getElementById("tbody-vuelos");
    const empty = document.getElementById("empty-vuelos");
    const filtroNumInput = document.getElementById("filtro-vuelo-num");
    const filtroAeroInput = document.getElementById("filtro-aerolinea");
    const datalistAero = document.getElementById("lista-aerolineas");
    tbody.innerHTML = "";

    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    // ✅ ahora usamos Set por ID_Vuelo (exacto), no solo por número
    const vuelosConPmrIds = new Set();
    cachePasajeros
      .filter(p => (p.estadoPmr || "").toLowerCase() === "en espera")
      .forEach(p => {
        const v = getVueloDePmr(p);
        if (v?.idVuelo) vuelosConPmrIds.add(String(v.idVuelo));
      });

    const filtroNum = (filtroNumInput?.value || "").trim().toLowerCase();
    const filtroAero = (filtroAeroInput?.value || "").trim().toLowerCase();

    if (datalistAero) {
      const setAero = new Set();
      cacheVuelos.forEach(v => { if (v.aerolinea) setAero.add(String(v.aerolinea)); });
      datalistAero.innerHTML = "";
      Array.from(setAero).sort().forEach(a => {
        const opt = document.createElement("option");
        opt.value = a;
        datalistAero.appendChild(opt);
      });
    }

    const filtrados = cacheVuelos.filter(v => {
      const f = parseFechaSolo(v.fecha);
      if (!f) return false;

      const esHoy = f.getTime() === hoy.getTime();
      const esManana = f.getTime() === manana.getTime();
      if (!esHoy && !esManana) return false;

      // ✅ conserva tu regla: solo próximas horas
      if (!vueloEsFuturo(v)) return false;

      // ✅ solo vuelos que realmente tienen PMR en espera, diferenciando duplicados por fecha
      if (!vuelosConPmrIds.has(String(v.idVuelo || ""))) return false;

      const numVuelo = (v.numeroVuelo || "").toString();
      const aerolinea = (v.aerolinea || "").toString();

      if (filtroNum && !numVuelo.toLowerCase().includes(filtroNum)) return false;
      if (filtroAero && aerolinea.toLowerCase() !== filtroAero) return false;

      return true;
    });

    empty.style.display = filtrados.length ? "none" : "block";

    filtrados.forEach(v => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.idVuelo || ""}</td>
        <td>${normalizarFechaExcel(v.fecha) || (v.fecha || "")}</td>
        <td>${formatearHora(v.horaProgramada)}</td>
        <td>${v.aerolinea || ""}</td>
        <td>${v.numeroVuelo || ""}</td>
        <td>${v.terminal || ""}</td>
        <td>${v.puerta || ""}</td>
        <td>${v.espigon || ""}</td>
        <td>${v.cantPmr || 0}</td>
        <td>${v.tipoServicio || ""}</td>
        <td>${v.estadoVuelo || ""}</td>
        <td>${v.tipo || v.tipoAvion || ""}</td>
        <td>${v.origen || ""}</td>
        <td>${v.destino || ""}</td>
        <td>${v.observaciones || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Vuelos";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Vuelos:</span><span>Hoy y mañana (solo próximas horas, con PMR en espera)</span>`;
  }

  function renderVistaPmr() {
    const tbody = document.getElementById("tbody-pmr");
    const empty = document.getElementById("empty-pmr");
    const selFiltroVuelo = document.getElementById("filtro-pmr-vuelo");
    const selFiltroEstado = document.getElementById("filtro-pmr-estado");
    tbody.innerHTML = "";

    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    let pmrBase = cachePasajeros.filter(p => {
      if ((p.estadoPmr || "").toLowerCase() !== "en espera") return false;
      const vuelo = getVueloDePmr(p);
      if (!vuelo) return false;

      const f = parseFechaSolo(vuelo.fecha);
      if (!f) return false;

      // hoy/mañana
      const okDia = (f.getTime() === hoy.getTime() || f.getTime() === manana.getTime());
      if (!okDia) return false;

      // solo próximos vuelos (igual que vista vuelos)
      if (!vueloEsFuturo(vuelo)) return false;

      return true;
    });

    // ✅ combo vuelo por N° + fecha (para separar duplicados)
    if (selFiltroVuelo) {
      const valorActual = selFiltroVuelo.value;
      selFiltroVuelo.innerHTML = '<option value="">Todos</option>';

      const setKeys = new Set();
      pmrBase.forEach(p => setKeys.add(pmrKey(p)));

      Array.from(setKeys).sort().forEach(k => {
        const [num, ymd] = k.includes("||") ? k.split("||") : [k, ""];
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = ymd ? `${num} | ${ymd}` : `${num}`;
        selFiltroVuelo.appendChild(opt);
      });

      if (valorActual) selFiltroVuelo.value = valorActual;
    }

    if (selFiltroEstado) {
      const valorActualEstado = selFiltroEstado.value;
      selFiltroEstado.innerHTML = '<option value="">Todos</option>';

      const setEstados = new Set();
      pmrBase.forEach(p => { if (p.estadoPmr) setEstados.add(String(p.estadoPmr)); });
      Array.from(setEstados).sort().forEach(est => {
        const opt = document.createElement("option");
        opt.value = est;
        opt.textContent = est;
        selFiltroEstado.appendChild(opt);
      });

      if (valorActualEstado) selFiltroEstado.value = valorActualEstado;
    }

    const vueloFiltroKey = (selFiltroVuelo?.value || "").trim();
    const estadoFiltro = (selFiltroEstado?.value || "").trim();

    if (vueloFiltroKey) pmrBase = pmrBase.filter(p => pmrKey(p) === vueloFiltroKey);
    if (estadoFiltro) pmrBase = pmrBase.filter(p => String(p.estadoPmr || "").trim() === estadoFiltro);

    empty.style.display = pmrBase.length ? "none" : "block";

    pmrBase.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.idPmr || ""}</td>
        <td>${p.vuelo || ""}</td>
        <td>${p.nombre || ""}</td>
        <td>${p.tipoAsistencia || ""}</td>
        <td>${p.edad || ""}</td>
        <td>${p.origen || ""}</td>
        <td>${p.destino || ""}</td>
        <td>${p.estadoPmr || ""}</td>
        <td>${p.idAgente || ""}</td>
        <td>${formatearHora(p.horaInicio)}</td>
        <td>${formatearHora(p.horaFin)}</td>
        <td>${p.observaciones || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Pasajeros PMR";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">PMR:</span><span>Vuelos de hoy y mañana (solo próximas horas, En espera)</span>`;
  }

  function renderVistaAsignaciones() {
    const tbody = document.getElementById("tbody-asignaciones");
    const empty = document.getElementById("empty-asignaciones");
    tbody.innerHTML = "";

    const filtroNumInput = document.getElementById("filtro-asig-vuelo-num");
    const filtroFechaInput = document.getElementById("filtro-asig-fecha");
    const selTipo = document.getElementById("filtro-asig-tipo");
    const selEstado = document.getElementById("filtro-asig-estado");

    if (selTipo) {
      const valActualTipo = selTipo.value;
      selTipo.innerHTML = '<option value="">Todos</option>';
      const setTipos = new Set();
      cacheAsignaciones.forEach(a => { if (a.tipoTraslado) setTipos.add(String(a.tipoTraslado)); });
      Array.from(setTipos).sort().forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        selTipo.appendChild(opt);
      });
      if (valActualTipo) selTipo.value = valActualTipo;
    }

    if (selEstado) {
      const valActualEstado = selEstado.value;
      selEstado.innerHTML = '<option value="">Todos</option>';
      const setEstados = new Set();
      cacheAsignaciones.forEach(a => { if (a.estadoAsignacion) setEstados.add(String(a.estadoAsignacion)); });
      Array.from(setEstados).sort().forEach(e => {
        const opt = document.createElement("option");
        opt.value = e;
        opt.textContent = e;
        selEstado.appendChild(opt);
      });
      if (valActualEstado) selEstado.value = valActualEstado;
    }

    const numFiltro = (filtroNumInput?.value || "").trim().toLowerCase();
    const fechaFiltro = (filtroFechaInput?.value || "").trim();
    const tipoFiltro = (selTipo?.value || "").trim().toLowerCase();
    const estadoFiltro = (selEstado?.value || "").trim().toLowerCase();

    const filtrados = cacheAsignaciones.filter(a => {
      if (numFiltro) {
        const vuelo = cacheVuelos.find(v => String(v.idVuelo) === String(a.idVuelo));
        const numVuelo = vuelo ? String(vuelo.numeroVuelo || "").toLowerCase() : "";
        if (!numVuelo.includes(numFiltro)) return false;
      }
      if (fechaFiltro) {
        const fa = parseFechaSolo(a.fechaAsignacion);
        const fFiltroDate = new Date(fechaFiltro);
        const fFiltro = new Date(fFiltroDate.getFullYear(), fFiltroDate.getMonth(), fFiltroDate.getDate());
        if (!fa || fa.getTime() !== fFiltro.getTime()) return false;
      }
      if (tipoFiltro) {
        const t = (a.tipoTraslado || "").toString().toLowerCase();
        if (t !== tipoFiltro) return false;
      }
      if (estadoFiltro) {
        const e = (a.estadoAsignacion || "").toString().toLowerCase();
        if (e !== estadoFiltro) return false;
      }
      return true;
    });

    empty.style.display = filtrados.length ? "none" : "block";

    filtrados.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.idAsignacion || ""}</td>
        <td>${a.idVuelo || ""}</td>
        <td>${a.idPmr || ""}</td>
        <td>${a.idAgente || ""}</td>
        <td>${a.fechaAsignacion || ""}</td>
        <td>${formatearHora(a.horaAsignacion)}</td>
        <td>${formatearHora(a.horaInicio)}</td>
        <td>${formatearHora(a.horaFin)}</td>
        <td>${a.estadoAsignacion || ""}</td>
        <td>${a.tipoTraslado || ""}</td>
        <td>${a.origenAsignacion || ""}</td>
        <td>${a.destinoAsignacion || ""}</td>
        <td>${a.justificacionCancel || ""}</td>
        <td>${formatearHora(a.horaLimite)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Asignaciones";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Asignaciones:</span><span>Según filtros actuales</span>`;
  }

  function renderVistaAgentes() {
    const tbody = document.getElementById("tbody-agentes");
    const empty = document.getElementById("empty-agentes");
    tbody.innerHTML = "";

    if (!cacheAgentes.length) { empty.style.display = "block"; return; }
    empty.style.display = "none";

    cacheAgentes.forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.idAgente || ""}</td>
        <td>${a.nombre || ""}</td>
        <td>${a.rut || ""}</td>
        <td>${a.telefono || ""}</td>
        <td>${a.estado || ""}</td>
        <td>${a.estadoServicio || ""}</td>
        <td>${a.ultimoServicio || ""}</td>
        <td>${a.observaciones || ""}</td>
        <td>${a.ubicacion || ""}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("view-title").textContent = "Agentes";
    document.getElementById("chip-info-vista").innerHTML =
      `<span class="chip-label">Agentes:</span><span>Lista completa de agentes</span>`;
  }

  /* --------- LLENAR COMBOS DE ACCIONES --------- */
  function llenarCombosAcciones() {
    const hoy = hoyTrunc();
    const manana = addDias(hoy, 1);

    // MODIFICAR VUELO (solo hoy) - value = ID_Vuelo, label = N° | fecha
    const selMod = document.getElementById("modificar-id-vuelo");
    selMod.innerHTML = '<option value="">— Seleccionar —</option>';
    cacheVuelos.forEach(v => {
      const f = parseFechaSolo(v.fecha);
      if (!f || f.getTime() !== hoy.getTime()) return;
      const opt = document.createElement("option");
      opt.value = v.idVuelo;
      opt.textContent = `${v.numeroVuelo || ""} | ${normalizarFechaExcel(v.fecha)}`;
      selMod.appendChild(opt);
    });

    // CREAR PASAJERO: value = ID_Vuelo (anti-duplicados)
    const selCrearPmrVuelo = document.getElementById("crear-pmr-vuelo");
    selCrearPmrVuelo.innerHTML = '<option value="">— Seleccionar vuelo —</option>';

    const vuelosOrdenados = [...cacheVuelos].sort((a,b)=>{
      const da = parseFechaSolo(a.fecha)?.getTime() || 0;
      const db = parseFechaSolo(b.fecha)?.getTime() || 0;
      if (da !== db) return da - db;
      return String(a.numeroVuelo||"").localeCompare(String(b.numeroVuelo||""));
    });

    vuelosOrdenados.forEach(v => {
      const ymd = normalizarFechaExcel(v.fecha);
      const opt = document.createElement("option");
      opt.value = v.idVuelo || "";
      opt.textContent = `${v.numeroVuelo || ""} | ${ymd} | ${v.terminal || ""}`;
      selCrearPmrVuelo.appendChild(opt);
    });

    // ASIGNAR PMR: hoy/mañana, en espera (incluye vuelo+fecha en label)
    const selPmr = document.getElementById("asig-select-pmr");
    selPmr.innerHTML = '<option value="">— Seleccionar PMR —</option>';

    cachePasajeros
      .filter(p => (p.estadoPmr || "").toLowerCase() === "en espera")
      .filter(p => {
        const vuelo = getVueloDePmr(p);
        if (!vuelo) return false;
        const f = parseFechaSolo(vuelo.fecha);
        if (!f) return false;
        const okDia = (f.getTime() === hoy.getTime() || f.getTime() === manana.getTime());
        if (!okDia) return false;
        if (!vueloEsFuturo(vuelo)) return false;
        return true;
      })
      .forEach(p => {
        const vuelo = getVueloDePmr(p);
        const terminal = vuelo ? (vuelo.terminal || "") : "";
        const key = pmrKey(p);
        const [num, ymd] = key.includes("||") ? key.split("||") : [key, ""];
        const opt = document.createElement("option");
        opt.value = p.idPmr;
        opt.textContent = `[${p.idPmr}] ${num}${ymd?(" | "+ymd):""} · ${p.nombre} · ${terminal || "Sin terminal"}`;
        selPmr.appendChild(opt);
      });

    const selAg = document.getElementById("asig-select-agente");
    selAg.innerHTML = '<option value="">— Selecciona primero un PMR —</option>';

    actualizarPreviewOrigenDestino();
  }

  function refrescarAgentesParaPmr() {
    const selPmr = document.getElementById("asig-select-pmr");
    const selAg = document.getElementById("asig-select-agente");
    selAg.innerHTML = "";

    const idPmr = selPmr.value;
    if (!idPmr) {
      selAg.innerHTML = '<option value="">— Selecciona primero un PMR —</option>';
      actualizarPreviewOrigenDestino();
      return;
    }

    const pmr = cachePasajeros.find(p => String(p.idPmr) === String(idPmr));
    if (!pmr) {
      selAg.innerHTML = '<option value="">No se encontró el PMR seleccionado</option>';
      actualizarPreviewOrigenDestino();
      return;
    }

    const vuelo = getVueloDePmr(pmr);
    const terminal = vuelo ? (vuelo.terminal || "") : "";
    const disponibles = agentesDisponiblesEnTerminal(terminal);

    if (!disponibles.length) {
      selAg.innerHTML = `<option value="">No hay agentes disponibles en ${terminal || "la terminal"}</option>`;
    } else {
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = `— Agentes disponibles en ${terminal || "terminal"} —`;
      selAg.appendChild(placeholder);

      disponibles.forEach(a => {
        const opt = document.createElement("option");
        opt.value = a.idAgente;
        opt.textContent = `${a.idAgente} · ${a.nombre}`;
        selAg.appendChild(opt);
      });
    }

    actualizarPreviewOrigenDestino();
  }

  function actualizarPreviewOrigenDestino() {
    const inputOrigen  = document.getElementById("asig-origen");
    const inputDestino = document.getElementById("asig-destino");
    const idPmr = document.getElementById("asig-select-pmr").value;
    const tipoT = document.getElementById("asig-tipo-traslado").value;

    if (!inputOrigen || !inputDestino) return;

    if (!idPmr || !tipoT) { inputOrigen.value = ""; inputDestino.value = ""; return; }

    const pmr = cachePasajeros.find(p => String(p.idPmr) === String(idPmr));
    if (!pmr) { inputOrigen.value = ""; inputDestino.value = ""; return; }

    const vuelo = getVueloDePmr(pmr);
    if (!vuelo) { inputOrigen.value = ""; inputDestino.value = ""; return; }

    const od = calcularOrigenDestinoFront(
      vuelo.tipoServicio,
      pmr.tipoAsistencia,
      tipoT,
      vuelo.puerta,
      vuelo.espigon
    );

    inputOrigen.value  = od.origen || "";
    inputDestino.value = od.destino || "";
  }

  /* --------- ACCIONES --------- */
  async function accionCrearVuelo() {
    const msg = document.getElementById("msg-crear-vuelo");
    msg.textContent = ""; msg.className = "msg";

    const fecha    = document.getElementById("crear-fecha").value;
    const hora     = document.getElementById("crear-hora").value;
    const aerol    = document.getElementById("crear-aerolinea").value.trim();
    const num      = document.getElementById("crear-numero").value.trim();
    const term     = document.getElementById("crear-terminal").value;
    const puerta   = document.getElementById("crear-puerta").value.trim();
    const espigon  = document.getElementById("crear-espigon").value.trim();
    const tipoAvion= document.getElementById("crear-tipo-avion").value;
    const origenV  = document.getElementById("crear-origen-vuelo").value.trim();
    const destinoV = document.getElementById("crear-destino-vuelo").value.trim();
    const cantPmr  = document.getElementById("crear-cant-pmr").value;
    const tipo     = document.getElementById("crear-tipo-servicio").value;
    const estadoV  = document.getElementById("crear-estado-vuelo").value;
    const obs      = document.getElementById("crear-obs").value.trim();

    if (!fecha || !hora || !aerol || !num || !term || !tipo) {
      msg.textContent = "Completa al menos: fecha, hora, aerolínea, número, terminal y tipo servicio.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","createVuelo");
    params.append("fecha",fecha);
    params.append("horaProgramada",hora);
    params.append("aerolinea",aerol);
    params.append("numeroVuelo",num);
    params.append("terminal",term);
    params.append("puerta",puerta);
    params.append("espigon",espigon);
    params.append("cantPmr",cantPmr || "0");
    params.append("tipoServicio",tipo);
    if (estadoV)  params.append("estadoVuelo",estadoV);
    if (tipoAvion)params.append("tipoAvion",tipoAvion);
    if (origenV)  params.append("origen",origenV);
    if (destinoV) params.append("destino",destinoV);
    if (obs)      params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al crear vuelo");
      msg.textContent = "Vuelo creado correctamente. ID: " + json.idVuelo;
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al crear vuelo: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  async function accionModificarVuelo() {
    const msg = document.getElementById("msg-modificar-vuelo");
    msg.textContent = ""; msg.className = "msg";

    const idVuelo = document.getElementById("modificar-id-vuelo").value;
    if (!idVuelo) { msg.textContent = "Selecciona un vuelo."; msg.className = "msg err"; return; }

    const nuevaFecha   = document.getElementById("modificar-fecha").value;
    const nuevaHora    = document.getElementById("modificar-hora").value;
    const nuevaPuerta  = document.getElementById("modificar-puerta").value.trim();
    const nuevoEspigon = document.getElementById("modificar-espigon").value.trim();

    if (!nuevaFecha && !nuevaHora && !nuevaPuerta && !nuevoEspigon) {
      msg.textContent = "No hay cambios para aplicar.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","modificarVuelo");
    params.append("idVuelo",idVuelo);
    if (nuevaFecha)   params.append("nuevaFecha",nuevaFecha);
    if (nuevaHora)    params.append("nuevaHora",nuevaHora);

    // compat backend
    if (nuevaPuerta)  { params.append("nuevaPuerta",nuevaPuerta); params.append("nuevoPuerta",nuevaPuerta); }
    if (nuevoEspigon) { params.append("nuevoEspigon",nuevoEspigon); params.append("nuevo_espigon",nuevoEspigon); }

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al modificar vuelo");
      msg.textContent = "Vuelo modificado correctamente.";
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al modificar vuelo: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  async function accionCargaMasiva() {
    const msg   = document.getElementById("msg-carga-masiva");
    const input = document.getElementById("input-carga-masiva");
    const btn   = document.getElementById("btn-carga-masiva");

    msg.textContent = ""; msg.className = "msg";

    const file = input.files && input.files[0];
    if (!file) { msg.textContent = "Selecciona un archivo Excel (.xlsx / .xls)."; msg.className = "msg err"; return; }

    btn.disabled = true;
    msg.textContent = "Leyendo archivo...";

    const reader = new FileReader();
    reader.onerror = () => { msg.textContent = "No se pudo leer el archivo."; msg.className = "msg err"; btn.disabled = false; };

    reader.onload = async (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, { type: "array" });
        const wsName = wb.SheetNames[0];
        const ws = wb.Sheets[wsName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

        if (!rows || rows.length <= 1) {
          msg.textContent = "No se encontraron filas de datos en el archivo.";
          msg.className = "msg err";
          btn.disabled = false;
          return;
        }

        const registros = [];

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];

          const nombre      = (row[0]  || "").toString().trim();
          const rut         = (row[1]  || "").toString().trim();
          const edadRaw     = row[2];
          const fechaRaw    = row[3];
          const horaRaw     = row[4];
          const tipoVuelo   = (row[5]  || "").toString().trim();
          const vueloNumRaw = row[6];
          const tipoAvion   = (row[7]  || "").toString().trim();
          const aerolinea   = (row[8]  || "").toString().trim();
          const terminal    = (row[9]  || "").toString().trim();
          const origen      = (row[10] || "").toString().trim();
          const destino     = (row[11] || "").toString().trim();
          const puerta      = (row[12] || "").toString().trim();
          const espigon     = (row[13] || "").toString().trim();
          const tipoPmr     = (row[14] || "").toString().trim();

          if (!nombre && !rut && !vueloNumRaw) continue;

          const numeroVuelo = vueloNumRaw ? String(vueloNumRaw).trim() : "";
          const fechaVuelo  = normalizarFechaExcel(fechaRaw);
          const hora        = normalizarHoraExcel(horaRaw);
          const edad        = (edadRaw !== "" && edadRaw !== null && edadRaw !== undefined) ? String(edadRaw).trim() : "";

          if (!numeroVuelo || !fechaVuelo) continue;

          registros.push({
            nombre, rut, edad,
            fechaVuelo, hora,
            tipoVuelo,
            vuelo: numeroVuelo,
            tipoAvion, aerolinea, terminal,
            origen, destino, puerta, espigon,
            tipoPmr
          });
        }

        if (!registros.length) {
          msg.textContent = "No se generaron registros válidos desde el archivo.";
          msg.className = "msg err";
          btn.disabled = false;
          return;
        }

        const chunkSize   = 2;
        const maxRetries  = 5;
        let totalPasajeros = 0;
        let totalVuelosNuevos = 0;
        let totalVuelosActualizados = 0;

        for (let i = 0; i < registros.length; i += chunkSize) {
          const chunk = registros.slice(i, i + chunkSize);
          const inicio = i + 1;
          const fin = Math.min(i + chunkSize, registros.length);

          let intentos = 0;
          let exito = false;

          while (!exito && intentos < maxRetries) {
            intentos++;
            try {
              msg.textContent =
                `Enviando registros ${inicio} a ${fin} de ${registros.length} ` +
                `(intento ${intentos}/${maxRetries})...`;

              const params = new URLSearchParams();
              params.append("action", "cargaMasivaPmr");
              params.append("payload", JSON.stringify(chunk));

              const res = await fetch(API_URL + "?" + params.toString());
              const json = await res.json();

              if (!json.ok) throw new Error(json.error || "Error en cargaMasivaPmr");

              totalPasajeros           += json.totalPasajeros || chunk.length;
              totalVuelosNuevos       += json.vuelosNuevos || 0;
              totalVuelosActualizados += json.vuelosActualizados || 0;

              exito = true;
            } catch (err) {
              console.warn(`Error al enviar chunk ${inicio}-${fin} (intento ${intentos})`, err);
              if (intentos >= maxRetries) {
                throw new Error(
                  `Se perdió la conexión al enviar los registros ${inicio}-${fin}. ` +
                  `Se intentó ${maxRetries} veces sin éxito. ` +
                  `Hasta ahora se cargaron ${totalPasajeros} pasajeros, ` +
                  `${totalVuelosNuevos} vuelos nuevos y ` +
                  `${totalVuelosActualizados} vuelos actualizados. ` +
                  `Detalle último error: ${err.message || err}`
                );
              }
              await new Promise(r => setTimeout(r, 1000));
            }
          }
        }

        msg.textContent =
          `Carga masiva completada. ` +
          `Pasajeros: ${totalPasajeros}, ` +
          `Vuelos nuevos: ${totalVuelosNuevos}, ` +
          `Vuelos actualizados: ${totalVuelosActualizados}.`;
        msg.className = "msg ok";

        input.value = "";
        await cargarDatos();

      } catch (error) {
        console.error(error);
        msg.textContent = "Error al procesar el archivo: " + (error.message || error);
        msg.className = "msg err";
      } finally {
        btn.disabled = false;
      }
    };

    reader.readAsArrayBuffer(file);
  }

  async function accionCargaOstrum() {
    const msg   = document.getElementById("msg-carga-ostrum");
    const input = document.getElementById("input-carga-ostrum");
    const btn   = document.getElementById("btn-carga-ostrum");
    const tipoOperacion = document.getElementById("ostrum-tipo-operacion").value || "Embarque";

    msg.textContent = ""; msg.className = "msg";

    const file = input.files && input.files[0];
    if (!file) { msg.textContent = "Selecciona un archivo Ostrum (.xlsx / .xls / .csv)."; msg.className = "msg err"; return; }

    btn.disabled = true;
    msg.textContent = "Leyendo archivo Ostrum...";

    try {
      const ext = (file.name || "").toLowerCase().split(".").pop();
      let rows = [];
      if (ext === "csv") {
        const text = await file.text();
        rows = parseCSV(text);
      } else {
        const ab = await file.arrayBuffer();
        const data = new Uint8Array(ab);
        const wb = XLSX.read(data, { type: "array" });
        const wsName = wb.SheetNames[0];
        const ws = wb.Sheets[wsName];
        rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
      }

      if (!rows || rows.length <= 1) {
        msg.textContent = "No se encontraron filas de datos en el archivo Ostrum.";
        msg.className = "msg err";
        return;
      }

      const headers = rows[0].map(h => String(h || "").trim());
      const dataRows = rows.slice(1);

      const idxVuelo = getColIndex(headers, ["flight", "vuelo", "n° vuelo", "numero vuelo", "número vuelo"]);
      const idxFecha = getColIndex(headers, ["date", "fecha"]);
      const idxTerm  = getColIndex(headers, ["term", "terminal"]);
      const idxPos   = getColIndex(headers, ["posición", "posicion", "position", "pos"]);
      const idxPuerta= getColIndex(headers, ["puerta", "gate"]);
      const idxFrom  = getColIndex(headers, ["from", "origen", "origin"]);
      const idxTo    = getColIndex(headers, ["to", "destino", "destination"]);
      const idxSch   = getColIndex(headers, ["sch", "scheduled"]);
      const idxEst   = getColIndex(headers, ["est", "estimated"]);
      const idxAct   = getColIndex(headers, ["act", "actual"]);
      const idxPmr   = getColIndex(headers, ["pmr", "prm"]);
      const idxAerol = getColIndex(headers, ["airline", "aerolinea", "aerolínea", "carrier"]);

      if (idxVuelo < 0 || idxFecha < 0 || idxPmr < 0) {
        msg.textContent = "No pude detectar columnas obligatorias en Ostrum. Necesito al menos: Flight/Vuelo, Date/Fecha y PMR/PRM.";
        msg.className = "msg err";
        return;
      }

      const registros = [];
      let filasSaltadas = 0;

      for (const r of dataRows) {
        const vuelo = limpiarStr(r[idxVuelo]);
        if (!vuelo) { filasSaltadas++; continue; }

        const fechaYmd = parseFechaOstrumToYmd(r[idxFecha]);
        if (!fechaYmd) { filasSaltadas++; continue; }

        const terminal = idxTerm >= 0 ? normalizarTerminalOstrum(r[idxTerm]) : "";
        const espigon  = idxPos >= 0 ? limpiarStr(r[idxPos]) : "";
        const puerta   = idxPuerta >= 0 ? limpiarStr(r[idxPuerta]) : "";
        const origen   = idxFrom >= 0 ? limpiarStr(r[idxFrom]) : "";
        const destino  = idxTo   >= 0 ? limpiarStr(r[idxTo]) : "";

        const hora = elegirHoraOstrum(r, idxAct, idxEst, idxSch);

        const pmrRaw = r[idxPmr];
        const tipos = parsePmrBreakdown(pmrRaw);
        if (!tipos.length) { filasSaltadas++; continue; }

        const aerolinea = idxAerol >= 0 ? limpiarStr(r[idxAerol]) : extraerAerolineaDesdeVuelo(vuelo);
        const contadorPorTipo = new Map();

        for (const tipo of tipos) {
          const cur = (contadorPorTipo.get(tipo) || 0) + 1;
          contadorPorTipo.set(tipo, cur);
          const nro2 = String(cur).padStart(2,"0");

          const rut = construirRutOstrum(fechaYmd, vuelo, tipo, nro2);
          const nombre = `${vuelo} Pasajero Ostrum ${nro2}`;

          registros.push({
            nombre,
            rut,
            edad: "",
            fechaVuelo: fechaYmd,
            hora: hora || "",
            tipoVuelo: tipoOperacion,
            vuelo: vuelo,
            tipoAvion: "",
            aerolinea: aerolinea,
            terminal: terminal,
            origen: origen,
            destino: destino,
            puerta: puerta,
            espigon: espigon,
            tipoPmr: tipo,
            observaciones: "[OSTRUM]"
          });
        }
      }

      if (!registros.length) {
        msg.textContent = "No se generaron registros válidos desde Ostrum (revisa columna PMR).";
        msg.className = "msg err";
        return;
      }

      const chunkSize  = 10;
      const maxRetries = 5;

      let totalPasajeros = 0;
      let totalVuelosNuevos = 0;
      let totalVuelosActualizados = 0;

      for (let i = 0; i < registros.length; i += chunkSize) {
        const chunk = registros.slice(i, i + chunkSize);
        const inicio = i + 1;
        const fin = Math.min(i + chunkSize, registros.length);

        let intentos = 0;
        let exito = false;

        while (!exito && intentos < maxRetries) {
          intentos++;
          try {
            msg.textContent =
              `Enviando Ostrum (${tipoOperacion}) ${inicio} a ${fin} de ${registros.length} ` +
              `(intento ${intentos}/${maxRetries})...`;

            const params = new URLSearchParams();
            params.append("action", "cargaMasivaOstrum");
            params.append("tipoOperacion", tipoOperacion);
            params.append("payload", JSON.stringify(chunk));

            const res = await fetch(API_URL + "?" + params.toString());
            const json = await res.json();

            if (!json.ok) throw new Error(json.error || "Error en cargaMasivaOstrum");

            totalPasajeros           += json.totalPasajeros || chunk.length;
            totalVuelosNuevos       += json.vuelosNuevos || 0;
            totalVuelosActualizados += json.vuelosActualizados || 0;

            exito = true;
          } catch (err) {
            console.warn(`Error al enviar chunk Ostrum ${inicio}-${fin} (intento ${intentos})`, err);
            if (intentos >= maxRetries) {
              throw new Error(
                `Se perdió la conexión al enviar Ostrum ${inicio}-${fin}. ` +
                `Se intentó ${maxRetries} veces sin éxito. ` +
                `Hasta ahora: pasajeros ${totalPasajeros}, vuelos nuevos ${totalVuelosNuevos}, vuelos actualizados ${totalVuelosActualizados}. ` +
                `Último error: ${err.message || err}`
              );
            }
            await new Promise(r => setTimeout(r, 1000));
          }
        }
      }

      msg.textContent =
        `Ostrum (${tipoOperacion}) completado. ` +
        `Pasajeros: ${totalPasajeros}, ` +
        `Vuelos nuevos: ${totalVuelosNuevos}, ` +
        `Vuelos actualizados: ${totalVuelosActualizados}.` +
        (filasSaltadas ? ` (Filas saltadas: ${filasSaltadas})` : "");
      msg.className = "msg ok";

      input.value = "";
      await cargarDatos();

    } catch (error) {
      console.error(error);
      msg.textContent = "Error al procesar Ostrum: " + (error.message || error);
      msg.className = "msg err";
    } finally {
      btn.disabled = false;
    }
  }

  // ✅ CREAR PASAJERO: selecciona por ID_Vuelo y envía vuelo+fechaVuelo (+ idVuelo)
  async function accionCrearPasajero() {
    const msg = document.getElementById("msg-crear-pmr");
    msg.textContent = ""; msg.className = "msg";

    const idVueloSel = document.getElementById("crear-pmr-vuelo").value;
    const nombre   = document.getElementById("crear-pmr-nombre").value.trim();
    const tipoAsis = document.getElementById("crear-pmr-tipo").value.trim();
    const edad     = document.getElementById("crear-pmr-edad").value;
    const origen   = document.getElementById("crear-pmr-origen").value.trim();
    const destino  = document.getElementById("crear-pmr-destino").value.trim();
    const obs      = document.getElementById("crear-pmr-obs").value.trim();

    if (!idVueloSel || !nombre || !tipoAsis) {
      msg.textContent = "Ingresa al menos vuelo, nombre y tipo de asistencia.";
      msg.className = "msg err";
      return;
    }

    const vueloObj = cacheVuelos.find(v => String(v.idVuelo) === String(idVueloSel));
    const numeroVuelo = vueloObj ? String(vueloObj.numeroVuelo || "").trim() : "";
    const fechaVueloYmd = vueloObj ? normalizarFechaExcel(vueloObj.fecha) : "";

    if (!numeroVuelo) {
      msg.textContent = "No pude encontrar el vuelo seleccionado en cache. Actualiza datos y reintenta.";
      msg.className = "msg err";
      return;
    }

    const params = new URLSearchParams();
    params.append("action","crearPasajero");

    // compat backend antiguo
    params.append("vuelo", numeroVuelo);

    // nuevo (anti-duplicados)
    params.append("idVuelo", idVueloSel);
    if (fechaVueloYmd) params.append("fechaVuelo", fechaVueloYmd);

    params.append("nombre",nombre);
    params.append("tipoAsistencia",tipoAsis);
    if (edad)    params.append("edad",edad);
    if (origen)  params.append("origen",origen);
    if (destino) params.append("destino",destino);
    if (obs)     params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al crear pasajero");

      msg.textContent = "Pasajero PMR creado correctamente. ID: " + json.idPmr;
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al crear pasajero: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  async function accionAsignarPmr() {
    const msg = document.getElementById("msg-asignar-pmr");
    msg.textContent = ""; msg.className = "msg";

    const idPmr    = document.getElementById("asig-select-pmr").value;
    const idAgente = document.getElementById("asig-select-agente").value;
    const tipoT    = document.getElementById("asig-tipo-traslado").value;
    const obs      = document.getElementById("asig-obs").value.trim();

    if (!idPmr)    { msg.textContent = "Selecciona un pasajero PMR."; msg.className = "msg err"; return; }
    if (!idAgente) { msg.textContent = "Selecciona un agente disponible."; msg.className = "msg err"; return; }
    if (!tipoT)    { msg.textContent = "Selecciona un tipo de traslado."; msg.className = "msg err"; return; }

    const params = new URLSearchParams();
    params.append("action","asignarPmrAgente");
    params.append("idPmr",idPmr);
    params.append("idAgente",idAgente);
    params.append("tipoTraslado",tipoT);
    params.append("observaciones",obs);

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "Error al asignar");

      msg.textContent = "Asignación creada correctamente.";
      msg.className = "msg ok";
      await cargarDatos();
    } catch (err) {
      msg.textContent = "Error al asignar PMR: " + (err.message || err);
      msg.className = "msg err";
    }
  }

  /* --------- EVENTOS --------- */
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".nav-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const vista = btn.dataset.view;
        document.querySelectorAll(".view-section").forEach(sec => sec.classList.remove("active"));
        document.getElementById("view-" + vista).classList.add("active");

        renderVistaActual();
      });
    });

    document.querySelectorAll(".action-tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".action-tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".action-form").forEach(f => f.classList.add("hidden"));

        btn.classList.add("active");
        const target = btn.dataset.target;
        const form = document.getElementById(target);
        if (form) form.classList.remove("hidden");
      });
    });

    document.getElementById("btn-crear-vuelo").addEventListener("click", accionCrearVuelo);
    document.getElementById("btn-modificar-vuelo").addEventListener("click", accionModificarVuelo);
    document.getElementById("btn-carga-masiva").addEventListener("click", accionCargaMasiva);
    document.getElementById("btn-carga-ostrum").addEventListener("click", accionCargaOstrum);
    document.getElementById("btn-crear-pmr").addEventListener("click", accionCrearPasajero);
    document.getElementById("btn-asignar-pmr").addEventListener("click", accionAsignarPmr);

    document.getElementById("asig-select-pmr").addEventListener("change", refrescarAgentesParaPmr);
    document.getElementById("asig-tipo-traslado").addEventListener("change", actualizarPreviewOrigenDestino);

    document.getElementById("btn-actualizar").addEventListener("click", () => cargarDatos());

    document.getElementById("filtro-vuelo-num").addEventListener("input", renderVistaVuelos);
    document.getElementById("filtro-aerolinea").addEventListener("input", renderVistaVuelos);

    document.getElementById("filtro-pmr-vuelo").addEventListener("change", renderVistaPmr);
    document.getElementById("filtro-pmr-estado").addEventListener("change", renderVistaPmr);

    document.getElementById("filtro-asig-vuelo-num").addEventListener("input", renderVistaAsignaciones);
    document.getElementById("filtro-asig-fecha").addEventListener("change", renderVistaAsignaciones);
    document.getElementById("filtro-asig-tipo").addEventListener("change", renderVistaAsignaciones);
    document.getElementById("filtro-asig-estado").addEventListener("change", renderVistaAsignaciones);

    cargarDatos();
  });
</script>
</body>
</html>
